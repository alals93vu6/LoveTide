# ğŸ­ åŠ‡æƒ…æ’­æ”¾ç³»çµ±æ¶æ§‹

> LoveTide åŠ‡æƒ…æ’­æ”¾ç³»çµ±çš„å®Œæ•´æŠ€è¡“æ¶æ§‹è¨­è¨ˆï¼ŒåŒ…å«å°è©±ç®¡ç†ã€å ´æ™¯æ§åˆ¶å’ŒåŠ‡æƒ…æµç¨‹ç®¡ç†

---

## ğŸ¯ æ¦‚è¿°

åŠ‡æƒ…æ’­æ”¾ç³»çµ±æ¶æ§‹æ˜¯ LoveTide éŠæˆ²çš„æ ¸å¿ƒæ•˜äº‹å¼•æ“ï¼Œè² è²¬ç®¡ç†å°è©±å±•ç¤ºã€è§’è‰²æ¼”å‡ºã€å ´æ™¯åˆ‡æ›å’ŒåŠ‡æƒ…é€²åº¦æ§åˆ¶ã€‚ç³»çµ±æ¡ç”¨åˆ†å±¤æ¶æ§‹è¨­è¨ˆï¼Œé€šéJSONé©…å‹•çš„å…§å®¹ç®¡ç†å’Œäº‹ä»¶é©…å‹•çš„æµç¨‹æ§åˆ¶ï¼Œå¯¦ç¾äº†é«˜åº¦éˆæ´»å’Œå¯æ“´å±•çš„åŠ‡æƒ…æ’­æ”¾é«”é©—ã€‚

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹åœ–

```
ğŸ­ åŠ‡æƒ…æ’­æ”¾ç³»çµ±æ¶æ§‹
â”‚
â”œâ”€â”€ ğŸ“Š åŠ‡æƒ…æ•¸æ“šå±¤ (Story Data Layer)
â”‚   â”œâ”€â”€ DialogDataManager - JSONå°è©±æ•¸æ“šç®¡ç†
â”‚   â”œâ”€â”€ StoryProgressTracker - åŠ‡æƒ…é€²åº¦è¿½è¹¤
â”‚   â”œâ”€â”€ ChoiceDataHandler - é¸æ“‡åˆ†æ”¯æ•¸æ“šè™•ç†
â”‚   â””â”€â”€ ScriptVariableManager - åŠ‡æƒ…è®Šæ•¸ç®¡ç†
â”‚
â”œâ”€â”€ ğŸ® åŠ‡æƒ…æ§åˆ¶å±¤ (Story Control Layer)
â”‚   â”œâ”€â”€ GamePlayingManagerDrama - åŠ‡æƒ…ä¸»æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ StoryFlowController - åŠ‡æƒ…æµç¨‹æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ ChoiceSystemManager - é¸æ“‡ç³»çµ±ç®¡ç†å™¨
â”‚   â””â”€â”€ StoryStateManager - åŠ‡æƒ…ç‹€æ…‹ç®¡ç†å™¨
â”‚
â”œâ”€â”€ ğŸ¨ å±•ç¤ºæ¸²æŸ“å±¤ (Presentation Layer)
â”‚   â”œâ”€â”€ TextBoxDrama - å°è©±æ–‡å­—æ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ ActorManagerDrama - è§’è‰²æ¼”å‡ºç®¡ç†å™¨
â”‚   â”œâ”€â”€ CGDisplay - CGå ´æ™¯å±•ç¤ºå™¨
â”‚   â””â”€â”€ UITransitionManager - UIè½‰å ´ç®¡ç†å™¨
â”‚
â”œâ”€â”€ ğŸµ å¤šåª’é«”å±¤ (Multimedia Layer)
â”‚   â”œâ”€â”€ StoryAudioManager - åŠ‡æƒ…éŸ³æ•ˆç®¡ç†å™¨
â”‚   â”œâ”€â”€ BackgroundMusicController - èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ VoicePlaybackManager - èªéŸ³æ’­æ”¾ç®¡ç†å™¨
â”‚   â””â”€â”€ SoundEffectController - éŸ³æ•ˆæ§åˆ¶å™¨
â”‚
â””â”€â”€ ğŸ”— æ•´åˆæœå‹™å±¤ (Integration Layer)
    â”œâ”€â”€ SaveSystemIntegration - å­˜æª”ç³»çµ±æ•´åˆ
    â”œâ”€â”€ NurturingModeIntegration - é¤Šæˆæ¨¡å¼æ•´åˆ
    â”œâ”€â”€ CGUnlockIntegration - CGè§£é–æ•´åˆ
    â””â”€â”€ EventBusIntegration - äº‹ä»¶ç³»çµ±æ•´åˆ
```

---

## ğŸ“Š åŠ‡æƒ…æ•¸æ“šå±¤æ¶æ§‹

### ğŸ—‚ï¸ DialogDataManager å°è©±æ•¸æ“šç®¡ç†å™¨
```csharp
public class DialogDataManager : MonoBehaviour
{
    [Header("æ•¸æ“šé…ç½®")]
    public string dialogDataPath = "DialogData/";
    public DialogData[] loadedDialogData;
    
    [Header("ç·©å­˜ç®¡ç†")]
    public int maxCacheSize = 50;
    private Dictionary<string, DialogData> dialogCache;
    private Queue<string> cacheQueue;
    
    #region å–®ä¾‹æ¨¡å¼
    public static DialogDataManager Instance { get; private set; }
    
    void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
            InitializeDataManager();
        }
        else
        {
            Destroy(gameObject);
        }
    }
    #endregion
    
    // ğŸš€ åˆå§‹åŒ–æ•¸æ“šç®¡ç†å™¨
    void InitializeDataManager()
    {
        dialogCache = new Dictionary<string, DialogData>();
        cacheQueue = new Queue<string>();
        
        // é è¼‰å…¥æ ¸å¿ƒå°è©±æ•¸æ“š
        PreloadCoreDialogData();
    }
    
    // ğŸ“– è¼‰å…¥å°è©±æ•¸æ“š
    public DialogData LoadDialogData(string dialogID)
    {
        // å„ªå…ˆå¾ç·©å­˜ä¸­ç²å–
        if (dialogCache.ContainsKey(dialogID))
        {
            return dialogCache[dialogID];
        }
        
        // å¾è³‡æºä¸­è¼‰å…¥
        DialogData dialogData = LoadDialogFromResources(dialogID);
        
        if (dialogData != null)
        {
            // åŠ å…¥ç·©å­˜
            AddToCache(dialogID, dialogData);
            return dialogData;
        }
        
        Debug.LogError($"æ‰¾ä¸åˆ°å°è©±æ•¸æ“š: {dialogID}");
        return null;
    }
    
    // ğŸ“¦ å¾è³‡æºè¼‰å…¥å°è©±æ•¸æ“š
    DialogData LoadDialogFromResources(string dialogID)
    {
        string resourcePath = $"{dialogDataPath}{dialogID}";
        
        try
        {
            TextAsset jsonFile = Resources.Load<TextAsset>(resourcePath);
            if (jsonFile != null)
            {
                DialogData dialogData = JsonUtility.FromJson<DialogData>(jsonFile.text);
                ProcessDialogData(dialogData);
                return dialogData;
            }
        }
        catch (System.Exception e)
        {
            Debug.LogError($"è¼‰å…¥å°è©±æ•¸æ“šå¤±æ•— {dialogID}: {e.Message}");
        }
        
        return null;
    }
    
    // ğŸ”„ è™•ç†å°è©±æ•¸æ“š
    void ProcessDialogData(DialogData dialogData)
    {
        // è™•ç†ç©å®¶åç¨±æ›¿æ›
        string playerName = GetPlayerName();
        
        foreach (var plotOption in dialogData.plotOptionsList)
        {
            foreach (var dialogDetail in plotOption.dialogDataDetails)
            {
                // æ›¿æ›ç©å®¶åç¨±ä½”ä½ç¬¦
                dialogDetail.sentence = dialogDetail.sentence.Replace("pName", playerName);
                
                // è™•ç†å…¶ä»–ç‰¹æ®Šæ¨™è¨˜
                ProcessSpecialTags(dialogDetail);
            }
        }
    }
    
    // ğŸ·ï¸ è™•ç†ç‰¹æ®Šæ¨™è¨˜
    void ProcessSpecialTags(DialogDataDetail dialogDetail)
    {
        // è™•ç†å‹•æ…‹å…§å®¹æ¨™è¨˜
        if (dialogDetail.sentence.Contains("{TIME}"))
        {
            string timeText = GetCurrentTimeText();
            dialogDetail.sentence = dialogDetail.sentence.Replace("{TIME}", timeText);
        }
        
        // è™•ç†æ•¸å€¼æ¨™è¨˜
        if (dialogDetail.sentence.Contains("{FRIENDSHIP}"))
        {
            string friendshipText = GetFriendshipText();
            dialogDetail.sentence = dialogDetail.sentence.Replace("{FRIENDSHIP}", friendshipText);
        }
    }
    
    // ğŸ’¾ åŠ å…¥ç·©å­˜
    void AddToCache(string dialogID, DialogData dialogData)
    {
        // æª¢æŸ¥ç·©å­˜å¤§å°é™åˆ¶
        if (dialogCache.Count >= maxCacheSize)
        {
            // ç§»é™¤æœ€èˆŠçš„ç·©å­˜é …ç›®
            string oldestKey = cacheQueue.Dequeue();
            dialogCache.Remove(oldestKey);
        }
        
        dialogCache[dialogID] = dialogData;
        cacheQueue.Enqueue(dialogID);
    }
    
    // ğŸ§¹ æ¸…ç†ç·©å­˜
    public void ClearCache()
    {
        dialogCache.Clear();
        cacheQueue.Clear();
    }
    
    // ğŸ“Š ç²å–ç©å®¶åç¨±
    string GetPlayerName()
    {
        return FindObjectOfType<NumericalRecords>()?.playerName ?? "ç©å®¶";
    }
    
    // ğŸ• ç²å–ç•¶å‰æ™‚é–“æ–‡å­—
    string GetCurrentTimeText()
    {
        var timeManager = FindObjectOfType<TimeManagerTest>();
        if (timeManager != null)
        {
            return timeManager.GetTimeDescription();
        }
        return "ç¾åœ¨";
    }
    
    // ğŸ’ ç²å–å¥½æ„Ÿåº¦æ–‡å­—
    string GetFriendshipText()
    {
        var numericalRecords = FindObjectOfType<NumericalRecords>();
        if (numericalRecords != null)
        {
            return GetFriendshipDescription(numericalRecords.friendship);
        }
        return "æ™®é€š";
    }
}
```

### ğŸ“ˆ StoryProgressTracker åŠ‡æƒ…é€²åº¦è¿½è¹¤å™¨
```csharp
public class StoryProgressTracker : MonoBehaviour
{
    [Header("é€²åº¦æ•¸æ“š")]
    public StoryProgressData progressData;
    
    [Header("é€²åº¦é…ç½®")]
    public StoryProgressConfig progressConfig;
    
    private Dictionary<string, int> storyFlags;
    private Dictionary<string, bool> eventFlags;
    
    void Start()
    {
        InitializeProgressTracker();
    }
    
    // ğŸš€ åˆå§‹åŒ–é€²åº¦è¿½è¹¤å™¨
    void InitializeProgressTracker()
    {
        LoadProgressData();
        InitializeFlags();
        
        // è¨‚é–±ç›¸é—œäº‹ä»¶
        EventBus.Instance.Subscribe<DialogCompleteEvent>("DialogComplete", OnDialogComplete);
        EventBus.Instance.Subscribe<ChoiceMadeEvent>("ChoiceMade", OnChoiceMade);
    }
    
    // ğŸ“Š è¼‰å…¥é€²åº¦æ•¸æ“š
    void LoadProgressData()
    {
        // å¾å­˜æª”ç³»çµ±è¼‰å…¥é€²åº¦
        var saveManager = FindObjectOfType<SaveDataManager>();
        if (saveManager != null)
        {
            progressData = saveManager.LoadStoryProgress();
        }
        
        if (progressData == null)
        {
            progressData = CreateNewProgressData();
        }
    }
    
    // ğŸ¯ æ›´æ–°åŠ‡æƒ…é€²åº¦
    public void UpdateStoryProgress(string storyID, int newProgress)
    {
        if (progressData.storyProgress.ContainsKey(storyID))
        {
            int currentProgress = progressData.storyProgress[storyID];
            if (newProgress > currentProgress)
            {
                progressData.storyProgress[storyID] = newProgress;
                OnProgressUpdated(storyID, newProgress);
            }
        }
        else
        {
            progressData.storyProgress[storyID] = newProgress;
            OnProgressUpdated(storyID, newProgress);
        }
        
        SaveProgressData();
    }
    
    // ğŸ–ï¸ è¨­å®šäº‹ä»¶æ¨™è¨˜
    public void SetEventFlag(string eventID, bool value)
    {
        progressData.eventFlags[eventID] = value;
        
        // è§¸ç™¼äº‹ä»¶æ¨™è¨˜è®Šæ›´äº‹ä»¶
        EventBus.Instance.Publish("EventFlagChanged", new EventFlagChangedEvent
        {
            eventID = eventID,
            newValue = value
        });
        
        SaveProgressData();
    }
    
    // ğŸ” æª¢æŸ¥é€²åº¦æ¢ä»¶
    public bool CheckProgressCondition(StoryCondition condition)
    {
        switch (condition.type)
        {
            case ConditionType.StoryProgress:
                return GetStoryProgress(condition.storyID) >= condition.requiredValue;
                
            case ConditionType.EventFlag:
                return GetEventFlag(condition.eventID) == condition.requiredBool;
                
            case ConditionType.PlayerStats:
                return CheckPlayerStatsCondition(condition);
                
            case ConditionType.TimeCondition:
                return CheckTimeCondition(condition);
                
            default:
                return true;
        }
    }
    
    // ğŸ“Š ç²å–åŠ‡æƒ…é€²åº¦
    public int GetStoryProgress(string storyID)
    {
        return progressData.storyProgress.ContainsKey(storyID) ? 
               progressData.storyProgress[storyID] : 0;
    }
    
    // ğŸ–ï¸ ç²å–äº‹ä»¶æ¨™è¨˜
    public bool GetEventFlag(string eventID)
    {
        return progressData.eventFlags.ContainsKey(eventID) ? 
               progressData.eventFlags[eventID] : false;
    }
    
    // ğŸ“¡ å°è©±å®Œæˆäº‹ä»¶è™•ç†
    void OnDialogComplete(DialogCompleteEvent eventData)
    {
        // æ›´æ–°å°è©±å®Œæˆé€²åº¦
        UpdateStoryProgress(eventData.dialogID, eventData.progressIncrement);
        
        // æª¢æŸ¥ä¸¦è§¸ç™¼ç›¸é—œäº‹ä»¶
        CheckAndTriggerEvents(eventData.dialogID);
    }
    
    // ğŸ“¡ é¸æ“‡å®Œæˆäº‹ä»¶è™•ç†
    void OnChoiceMade(ChoiceMadeEvent eventData)
    {
        // è¨˜éŒ„é¸æ“‡çµæœ
        string choiceKey = $"{eventData.dialogID}_choice_{eventData.choiceIndex}";
        SetEventFlag(choiceKey, true);
        
        // è™•ç†é¸æ“‡å¾Œæœ
        ProcessChoiceConsequences(eventData);
    }
    
    // ğŸ’¾ ä¿å­˜é€²åº¦æ•¸æ“š
    void SaveProgressData()
    {
        var saveManager = FindObjectOfType<SaveDataManager>();
        if (saveManager != null)
        {
            saveManager.SaveStoryProgress(progressData);
        }
    }
}
```

---

## ğŸ® åŠ‡æƒ…æ§åˆ¶å±¤æ¶æ§‹

### ğŸ¬ GamePlayingManagerDrama åŠ‡æƒ…ä¸»æ§åˆ¶å™¨
```csharp
public class GamePlayingManagerDrama : MonoBehaviour
{
    [Header("ç³»çµ±çµ„ä»¶")]
    public TextBoxDrama textBoxDrama;
    public ActorManagerDrama actorManager;
    public CGDisplay cgDisplay;
    public StoryAudioManager audioManager;
    
    [Header("æµç¨‹æ§åˆ¶")]
    public StoryFlowController flowController;
    public ChoiceSystemManager choiceSystem;
    public StoryStateManager stateManager;
    
    [Header("æ•¸æ“šç®¡ç†")]
    public DialogDataManager dataManager;
    public StoryProgressTracker progressTracker;
    
    [Header("ç•¶å‰ç‹€æ…‹")]
    public string currentDialogID;
    public int currentDialogIndex;
    public StoryState currentState = StoryState.Idle;
    
    void Start()
    {
        InitializeDramaManager();
    }
    
    // ğŸš€ åˆå§‹åŒ–åŠ‡æƒ…ç®¡ç†å™¨
    void InitializeDramaManager()
    {
        // åˆå§‹åŒ–å„å€‹å­ç³»çµ±
        InitializeSubSystems();
        
        // è¨‚é–±äº‹ä»¶
        SubscribeToEvents();
        
        // è¨­å®šåˆå§‹ç‹€æ…‹
        SetInitialState();
    }
    
    // ğŸ¯ é–‹å§‹åŠ‡æƒ…æ’­æ”¾
    public void StartStoryPlayback(string dialogID, int startIndex = 0)
    {
        if (currentState != StoryState.Idle)
        {
            Debug.LogWarning("åŠ‡æƒ…ç³»çµ±å¿™ç¢Œä¸­ï¼Œç„¡æ³•é–‹å§‹æ–°çš„åŠ‡æƒ…");
            return;
        }
        
        currentDialogID = dialogID;
        currentDialogIndex = startIndex;
        
        // è¼‰å…¥å°è©±æ•¸æ“š
        DialogData dialogData = dataManager.LoadDialogData(dialogID);
        if (dialogData == null)
        {
            Debug.LogError($"ç„¡æ³•è¼‰å…¥å°è©±æ•¸æ“š: {dialogID}");
            return;
        }
        
        // è¨­å®šåŠ‡æƒ…ç‹€æ…‹
        stateManager.SetState(StoryState.Playing);
        
        // åˆå§‹åŒ–åŠ‡æƒ…æ’­æ”¾ç’°å¢ƒ
        InitializeStoryEnvironment(dialogData);
        
        // é–‹å§‹æ’­æ”¾ç¬¬ä¸€æ®µå°è©±
        PlayCurrentDialog();
    }
    
    // ğŸ­ æ’­æ”¾ç•¶å‰å°è©±
    void PlayCurrentDialog()
    {
        DialogData dialogData = dataManager.LoadDialogData(currentDialogID);
        if (dialogData == null || currentDialogIndex >= dialogData.plotOptionsList.Count)
        {
            // åŠ‡æƒ…çµæŸ
            EndStoryPlayback();
            return;
        }
        
        var currentPlot = dialogData.plotOptionsList[currentDialogIndex];
        
        // æª¢æŸ¥æ’­æ”¾æ¢ä»¶
        if (!CheckPlayConditions(currentPlot))
        {
            // è·³éé€™æ®µåŠ‡æƒ…
            AdvanceToNextDialog();
            return;
        }
        
        // è¨­å®šæ¼”å“¡ç‹€æ…‹
        actorManager.SetupActorsForDialog(currentPlot);
        
        // è¨­å®šCGå ´æ™¯
        if (currentPlot.requiresCGDisplay)
        {
            cgDisplay.DisplayCGScene(currentPlot.cgIndex);
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        if (!string.IsNullOrEmpty(currentPlot.bgmName))
        {
            audioManager.PlayBackgroundMusic(currentPlot.bgmName);
        }
        
        // é–‹å§‹æ–‡å­—é¡¯ç¤º
        textBoxDrama.StartTextDisplay(currentPlot);
    }
    
    // â­ï¸ é€²å…¥ä¸‹ä¸€æ®µå°è©±
    public void AdvanceToNextDialog()
    {
        DialogData dialogData = dataManager.LoadDialogData(currentDialogID);
        
        if (currentDialogIndex < dialogData.plotOptionsList.Count - 1)
        {
            currentDialogIndex++;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡åˆ†æ”¯
            var currentPlot = dialogData.plotOptionsList[currentDialogIndex];
            if (currentPlot.hasChoices)
            {
                ShowChoiceOptions(currentPlot);
            }
            else
            {
                PlayCurrentDialog();
            }
        }
        else
        {
            // åŠ‡æƒ…çµæŸ
            EndStoryPlayback();
        }
    }
    
    // ğŸ”€ é¡¯ç¤ºé¸æ“‡é¸é …
    void ShowChoiceOptions(PlotOptions plotOption)
    {
        stateManager.SetState(StoryState.WaitingForChoice);
        choiceSystem.ShowChoices(plotOption.choices, OnChoiceSelected);
    }
    
    // âœ… é¸æ“‡å®Œæˆå›èª¿
    void OnChoiceSelected(int choiceIndex)
    {
        // è™•ç†é¸æ“‡çµæœ
        ProcessChoiceResult(choiceIndex);
        
        // ç¹¼çºŒåŠ‡æƒ…
        stateManager.SetState(StoryState.Playing);
        AdvanceToNextDialog();
    }
    
    // ğŸ¬ è™•ç†é¸æ“‡çµæœ
    void ProcessChoiceResult(int choiceIndex)
    {
        DialogData dialogData = dataManager.LoadDialogData(currentDialogID);
        var currentPlot = dialogData.plotOptionsList[currentDialogIndex];
        
        if (choiceIndex < currentPlot.choices.Length)
        {
            var selectedChoice = currentPlot.choices[choiceIndex];
            
            // æ‡‰ç”¨é¸æ“‡å¾Œæœ
            ApplyChoiceConsequences(selectedChoice);
            
            // è§¸ç™¼é¸æ“‡äº‹ä»¶
            EventBus.Instance.Publish("ChoiceMade", new ChoiceMadeEvent
            {
                dialogID = currentDialogID,
                choiceIndex = choiceIndex,
                choiceText = selectedChoice.choiceText
            });
        }
    }
    
    // ğŸŠ æ‡‰ç”¨é¸æ“‡å¾Œæœ
    void ApplyChoiceConsequences(ChoiceData choiceData)
    {
        // æ•¸å€¼è®ŠåŒ–
        if (choiceData.statChanges != null)
        {
            var numericalRecords = FindObjectOfType<NumericalRecords>();
            foreach (var statChange in choiceData.statChanges)
            {
                numericalRecords.ModifyStat(statChange.statName, statChange.changeValue);
            }
        }
        
        // äº‹ä»¶æ¨™è¨˜
        if (!string.IsNullOrEmpty(choiceData.eventFlag))
        {
            progressTracker.SetEventFlag(choiceData.eventFlag, true);
        }
        
        // åŠ‡æƒ…åˆ†æ”¯
        if (!string.IsNullOrEmpty(choiceData.branchDialogID))
        {
            // è·³è½‰åˆ°æ–°çš„åŠ‡æƒ…åˆ†æ”¯
            StartStoryPlayback(choiceData.branchDialogID);
        }
    }
    
    // ğŸ çµæŸåŠ‡æƒ…æ’­æ”¾
    void EndStoryPlayback()
    {
        // æ›´æ–°åŠ‡æƒ…é€²åº¦
        progressTracker.UpdateStoryProgress(currentDialogID, currentDialogIndex + 1);
        
        // æ¸…ç†åŠ‡æƒ…ç’°å¢ƒ
        CleanupStoryEnvironment();
        
        // è¨­å®šç‹€æ…‹ç‚ºé–’ç½®
        stateManager.SetState(StoryState.Idle);
        
        // è§¸ç™¼åŠ‡æƒ…çµæŸäº‹ä»¶
        EventBus.Instance.Publish("StoryComplete", new StoryCompleteEvent
        {
            dialogID = currentDialogID,
            completedAt = System.DateTime.Now
        });
        
        // æª¢æŸ¥CGè§£é–
        CheckAndUnlockCG();
        
        // è¿”å›ä¸»éŠæˆ²æˆ–åˆ‡æ›å ´æ™¯
        HandleStoryCompletion();
    }
    
    // ğŸ–¼ï¸ æª¢æŸ¥ä¸¦è§£é–CG
    void CheckAndUnlockCG()
    {
        string eventID = $"story_complete_{currentDialogID}";
        CGUnlockManager.Instance.ProcessEventUnlock(eventID);
    }
    
    // ğŸ”„ è™•ç†åŠ‡æƒ…å®Œæˆ
    void HandleStoryCompletion()
    {
        // æ ¹æ“šåŠ‡æƒ…é¡å‹æ±ºå®šå¾ŒçºŒè¡Œå‹•
        DialogData dialogData = dataManager.LoadDialogData(currentDialogID);
        
        if (dialogData.returnToNurturingMode)
        {
            // è¿”å›é¤Šæˆæ¨¡å¼
            SceneManager.LoadScene("NurturingMode");
        }
        else if (!string.IsNullOrEmpty(dialogData.nextSceneName))
        {
            // è¼‰å…¥æŒ‡å®šå ´æ™¯
            SceneManager.LoadScene(dialogData.nextSceneName);
        }
        else
        {
            // é»˜èªè¿”å›ä¸»é¸å–®
            SceneManager.LoadScene("MainMenu");
        }
    }
    
    // ğŸ§¹ æ¸…ç†åŠ‡æƒ…ç’°å¢ƒ
    void CleanupStoryEnvironment()
    {
        textBoxDrama.ClearDisplay();
        actorManager.ResetAllActors();
        cgDisplay.HideAllCG();
        audioManager.StopAllAudio();
    }
}
```

---

## ğŸ¨ å±•ç¤ºæ¸²æŸ“å±¤æ¶æ§‹

### ğŸ“ TextBoxDrama å°è©±æ–‡å­—æ¸²æŸ“å™¨
```csharp
public class TextBoxDrama : MonoBehaviour
{
    [Header("UIçµ„ä»¶")]
    public Text nameText;
    public Text contentText;
    public Image dialogBackground;
    public CanvasGroup dialogCanvasGroup;
    
    [Header("æ‰“å­—æ©Ÿæ•ˆæœ")]
    public float defaultTypeSpeed = 0.05f;
    public AnimationCurve typeSpeedCurve;
    public AudioClip typingSound;
    
    [Header("æ–‡å­—æ•ˆæœ")]
    public TextEffectController textEffectController;
    public Color[] characterColors;
    
    private Coroutine typingCoroutine;
    private bool isTyping = false;
    private bool isSkipRequested = false;
    
    // ğŸ¯ é–‹å§‹æ–‡å­—é¡¯ç¤º
    public void StartTextDisplay(PlotOptions plotOption)
    {
        if (plotOption.dialogDataDetails.Count == 0)
        {
            Debug.LogWarning("æ²’æœ‰å°è©±å…§å®¹å¯é¡¯ç¤º");
            return;
        }
        
        // é¡¯ç¤ºå°è©±æ¡†
        ShowDialogBox();
        
        // é–‹å§‹é¡¯ç¤ºå°è©±å…§å®¹
        StartCoroutine(DisplayDialogSequence(plotOption));
    }
    
    // ğŸ­ é¡¯ç¤ºå°è©±åºåˆ—
    IEnumerator DisplayDialogSequence(PlotOptions plotOption)
    {
        foreach (var dialogDetail in plotOption.dialogDataDetails)
        {
            // è¨­å®šè§’è‰²åç¨±
            SetCharacterName(dialogDetail.speaker);
            
            // è¨­å®šæ–‡å­—é¡è‰²
            SetTextColor(dialogDetail.speaker);
            
            // é¡¯ç¤ºå°è©±å…§å®¹
            yield return StartCoroutine(TypewriterEffect(dialogDetail.sentence, dialogDetail.typeSpeed));
            
            // ç­‰å¾…ç©å®¶è¼¸å…¥
            yield return StartCoroutine(WaitForPlayerInput());
            
            // è™•ç†ç‰¹æ®Šæ•ˆæœ
            if (dialogDetail.hasSpecialEffect)
            {
                yield return StartCoroutine(PlaySpecialEffect(dialogDetail.effectType));
            }
        }
        
        // é€šçŸ¥å°è©±å®Œæˆ
        NotifyDialogComplete();
    }
    
    // âŒ¨ï¸ æ‰“å­—æ©Ÿæ•ˆæœ
    IEnumerator TypewriterEffect(string fullText, float customSpeed = -1)
    {
        isTyping = true;
        isSkipRequested = false;
        
        float typeSpeed = customSpeed > 0 ? customSpeed : defaultTypeSpeed;
        contentText.text = "";
        
        for (int i = 0; i < fullText.Length; i++)
        {
            // æª¢æŸ¥è·³éè«‹æ±‚
            if (isSkipRequested)
            {
                contentText.text = fullText;
                break;
            }
            
            // æ·»åŠ å­—ç¬¦
            contentText.text += fullText[i];
            
            // æ’­æ”¾æ‰“å­—éŸ³æ•ˆ
            if (typingSound != null && i % 3 == 0) // æ¯3å€‹å­—ç¬¦æ’­æ”¾ä¸€æ¬¡éŸ³æ•ˆ
            {
                AudioSource.PlayClipAtPoint(typingSound, transform.position, 0.3f);
            }
            
            // è™•ç†ç‰¹æ®Šå­—ç¬¦
            if (IsSpecialCharacter(fullText[i]))
            {
                yield return new WaitForSeconds(typeSpeed * 2); // æ¨™é»ç¬¦è™Ÿåœé “æ›´ä¹…
            }
            else
            {
                float dynamicSpeed = GetDynamicTypeSpeed(i, fullText.Length, typeSpeed);
                yield return new WaitForSeconds(dynamicSpeed);
            }
        }
        
        isTyping = false;
    }
    
    // âš¡ ç²å–å‹•æ…‹æ‰“å­—é€Ÿåº¦
    float GetDynamicTypeSpeed(int currentIndex, int totalLength, float baseSpeed)
    {
        float progress = (float)currentIndex / totalLength;
        float speedMultiplier = typeSpeedCurve.Evaluate(progress);
        return baseSpeed * speedMultiplier;
    }
    
    // ğŸ‘† ç­‰å¾…ç©å®¶è¼¸å…¥
    IEnumerator WaitForPlayerInput()
    {
        // é¡¯ç¤ºç¹¼çºŒæç¤º
        ShowContinueIndicator(true);
        
        bool inputReceived = false;
        
        while (!inputReceived)
        {
            // æª¢æŸ¥é»æ“Šæˆ–æŒ‰éµè¼¸å…¥
            if (Input.GetMouseButtonDown(0) || Input.GetKeyDown(KeyCode.Space) || Input.GetKeyDown(KeyCode.Return))
            {
                if (isTyping)
                {
                    // å¦‚æœæ­£åœ¨æ‰“å­—ï¼Œå‰‡è·³éæ‰“å­—æ•ˆæœ
                    isSkipRequested = true;
                    yield return new WaitUntil(() => !isTyping);
                }
                else
                {
                    // ç¹¼çºŒä¸‹ä¸€æ®µå°è©±
                    inputReceived = true;
                }
            }
            
            yield return null;
        }
        
        // éš±è—ç¹¼çºŒæç¤º
        ShowContinueIndicator(false);
    }
    
    // ğŸ¨ è¨­å®šè§’è‰²åç¨±
    void SetCharacterName(Speaker speaker)
    {
        string characterName = GetCharacterName(speaker);
        nameText.text = characterName;
        
        // è¨­å®šåç¨±é¡è‰²
        Color nameColor = GetCharacterColor(speaker);
        nameText.color = nameColor;
    }
    
    // ğŸŒˆ è¨­å®šæ–‡å­—é¡è‰²
    void SetTextColor(Speaker speaker)
    {
        Color textColor = GetCharacterColor(speaker);
        contentText.color = textColor;
    }
    
    // ğŸ‘¥ ç²å–è§’è‰²åç¨±
    string GetCharacterName(Speaker speaker)
    {
        switch (speaker)
        {
            case Speaker.Player:
                return FindObjectOfType<NumericalRecords>()?.playerName ?? "ç©å®¶";
            case Speaker.GirlFriend:
                return "ç”±é¦™";
            case Speaker.Chorus:
                return "";
            default:
                return speaker.ToString();
        }
    }
    
    // ğŸ¨ ç²å–è§’è‰²é¡è‰²
    Color GetCharacterColor(Speaker speaker)
    {
        int colorIndex = (int)speaker;
        if (colorIndex < characterColors.Length)
        {
            return characterColors[colorIndex];
        }
        return Color.white;
    }
    
    // âœ¨ æ’­æ”¾ç‰¹æ®Šæ•ˆæœ
    IEnumerator PlaySpecialEffect(TextEffectType effectType)
    {
        switch (effectType)
        {
            case TextEffectType.Shake:
                yield return StartCoroutine(textEffectController.ShakeText(contentText, 0.5f));
                break;
                
            case TextEffectType.Fade:
                yield return StartCoroutine(textEffectController.FadeText(contentText, 1.0f));
                break;
                
            case TextEffectType.ColorChange:
                yield return StartCoroutine(textEffectController.ColorChangeText(contentText, Color.red, 0.8f));
                break;
                
            default:
                yield return null;
                break;
        }
    }
    
    // ğŸ“¢ é€šçŸ¥å°è©±å®Œæˆ
    void NotifyDialogComplete()
    {
        EventBus.Instance.Publish("DialogSegmentComplete", new DialogSegmentCompleteEvent
        {
            timestamp = System.DateTime.Now
        });
    }
    
    // ğŸ­ é¡¯ç¤ºå°è©±æ¡†
    void ShowDialogBox()
    {
        dialogCanvasGroup.alpha = 0;
        gameObject.SetActive(true);
        
        StartCoroutine(FadeInDialogBox());
    }
    
    // ğŸŒ… æ·¡å…¥å°è©±æ¡†
    IEnumerator FadeInDialogBox()
    {
        float elapsedTime = 0;
        float fadeTime = 0.3f;
        
        while (elapsedTime < fadeTime)
        {
            elapsedTime += Time.deltaTime;
            dialogCanvasGroup.alpha = Mathf.Clamp01(elapsedTime / fadeTime);
            yield return null;
        }
        
        dialogCanvasGroup.alpha = 1;
    }
    
    // ğŸ§¹ æ¸…ç†é¡¯ç¤º
    public void ClearDisplay()
    {
        if (typingCoroutine != null)
        {
            StopCoroutine(typingCoroutine);
        }
        
        contentText.text = "";
        nameText.text = "";
        gameObject.SetActive(false);
    }
}
```

---

## ğŸ”— æ•´åˆæœå‹™å±¤æ¶æ§‹

### ğŸ’¾ SaveSystemIntegration å­˜æª”ç³»çµ±æ•´åˆ
```csharp
public class SaveSystemIntegration : MonoBehaviour
{
    [Header("å­˜æª”çµ„ä»¶")]
    public SaveDataManager saveManager;
    public StoryProgressTracker progressTracker;
    
    void Start()
    {
        InitializeIntegration();
    }
    
    // ğŸš€ åˆå§‹åŒ–æ•´åˆ
    void InitializeIntegration()
    {
        // è¨‚é–±åŠ‡æƒ…ç³»çµ±äº‹ä»¶
        EventBus.Instance.Subscribe<StoryCompleteEvent>("StoryComplete", OnStoryComplete);
        EventBus.Instance.Subscribe<ChoiceMadeEvent>("ChoiceMade", OnChoiceMade);
        EventBus.Instance.Subscribe<EventFlagChangedEvent>("EventFlagChanged", OnEventFlagChanged);
    }
    
    // ğŸ“š åŠ‡æƒ…å®Œæˆè™•ç†
    void OnStoryComplete(StoryCompleteEvent eventData)
    {
        // è‡ªå‹•ä¿å­˜åŠ‡æƒ…é€²åº¦
        AutoSaveStoryProgress(eventData);
        
        // æ›´æ–°å­˜æª”ä¸­çš„åŠ‡æƒ…çµ±è¨ˆ
        UpdateStoryStatistics(eventData);
    }
    
    // ğŸ”€ é¸æ“‡å®Œæˆè™•ç†
    void OnChoiceMade(ChoiceMadeEvent eventData)
    {
        // è¨˜éŒ„é¸æ“‡æ­·å²
        RecordChoiceHistory(eventData);
    }
    
    // ğŸ–ï¸ äº‹ä»¶æ¨™è¨˜è®Šæ›´è™•ç†
    void OnEventFlagChanged(EventFlagChangedEvent eventData)
    {
        // åŒæ­¥äº‹ä»¶æ¨™è¨˜åˆ°å­˜æª”
        SyncEventFlagToSave(eventData);
    }
    
    // ğŸ’¾ è‡ªå‹•ä¿å­˜åŠ‡æƒ…é€²åº¦
    void AutoSaveStoryProgress(StoryCompleteEvent eventData)
    {
        var currentSave = saveManager.GetCurrentSaveData();
        
        if (currentSave != null)
        {
            // æ›´æ–°åŠ‡æƒ…é€²åº¦è¨˜éŒ„
            currentSave.storyProgress[eventData.dialogID] = true;
            currentSave.lastStoryPlayTime = eventData.completedAt;
            
            // ä¿å­˜åˆ°ç•¶å‰å­˜æª”æ§½ä½
            saveManager.SaveCurrentGame();
        }
    }
}
```

---

## ğŸ“Š æ•¸æ“šæµåœ–

```
ğŸ­ åŠ‡æƒ…æ’­æ”¾ç³»çµ±æ•¸æ“šæµ
â”‚
ğŸ“¥ åŠ‡æƒ…è§¸ç™¼
    â†“
ğŸ—‚ï¸ DialogDataManager.LoadDialogData()
    â†“
ğŸ“Š StoryProgressTracker.CheckConditions()
    â†“
ğŸ® GamePlayingManagerDrama.StartStoryPlayback()
    â†“
ğŸ¨ TextBoxDrama.StartTextDisplay()
    â†“
ğŸ‘¤ ActorManagerDrama.SetupActors()
    â†“
ğŸ–¼ï¸ CGDisplay.DisplayScene() (å¦‚éœ€è¦)
    â†“
ğŸµ StoryAudioManager.PlayAudio()
    â†“
ğŸ‘† ç­‰å¾…ç©å®¶è¼¸å…¥
    â†“
ğŸ”€ ChoiceSystemManager.ProcessChoice() (å¦‚æœ‰é¸æ“‡)
    â†“
ğŸ“ˆ StoryProgressTracker.UpdateProgress()
    â†“
ğŸ’¾ SaveSystemIntegration.AutoSave()
    â†“
ğŸ–¼ï¸ CGUnlockIntegration.CheckUnlock()
    â†“
ğŸ åŠ‡æƒ…å®Œæˆ / è¿”å›éŠæˆ²
```

---

## ğŸ’¬ Claude ä½¿ç”¨æç¤º

### ğŸ¯ æ¶æ§‹é‡é»
1. **åˆ†å±¤è¨­è¨ˆ**: æ¸…æ™°çš„è·è²¬åˆ†é›¢ï¼Œä¾¿æ–¼ç¶­è­·å’Œæ“´å±•
2. **äº‹ä»¶é©…å‹•**: ä½¿ç”¨EventBuså¯¦ç¾çµ„ä»¶é–“è§£è€¦é€šä¿¡
3. **æ•¸æ“šé©…å‹•**: JSONé©…å‹•çš„å…§å®¹ç®¡ç†ï¼Œæ”¯æ´ç†±æ›´æ–°
4. **ç‹€æ…‹ç®¡ç†**: å®Œæ•´çš„åŠ‡æƒ…æ’­æ”¾ç‹€æ…‹æ§åˆ¶

### ğŸ”§ é–‹ç™¼å»ºè­°
- å„ªå…ˆå¯¦ä½œDialogDataManagerå’ŒåŸºç¤æ•¸æ“šçµæ§‹
- ç¢ºä¿äº‹ä»¶ç³»çµ±çš„ç©©å®šæ€§å’ŒéŒ¯èª¤è™•ç†
- æ³¨é‡æ–‡å­—é¡¯ç¤ºæ•ˆæœå’Œç”¨æˆ¶é«”é©—
- è€ƒæ…®å¤§é‡å°è©±æ•¸æ“šçš„æ€§èƒ½å„ªåŒ–

### âš ï¸ æ³¨æ„äº‹é …
- JSONæ–‡ä»¶çš„ç‰ˆæœ¬å…¼å®¹æ€§è™•ç†
- å°è©±æ•¸æ“šçš„ç·©å­˜ç®¡ç†
- åŠ‡æƒ…åˆ†æ”¯çš„è¤‡é›œåº¦æ§åˆ¶
- å­˜æª”ç³»çµ±çš„æ•¸æ“šåŒæ­¥

---

**æœ€å¾Œæ›´æ–°**: 2025-07-30  
**ç‰ˆæœ¬**: 1.0  
**ç¶­è­·è€…**: é–‹ç™¼åœ˜éšŠ + Claude AI

> ğŸ­ **æ¶æ§‹äº®é»**: åŠ‡æƒ…æ’­æ”¾ç³»çµ±æ¶æ§‹æ¡ç”¨åˆ†å±¤æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œé€šéJSONé©…å‹•çš„å…§å®¹ç®¡ç†å’Œäº‹ä»¶é©…å‹•çš„æµç¨‹æ§åˆ¶ï¼Œå¯¦ç¾äº†é«˜åº¦éˆæ´»å’Œå¯æ“´å±•çš„æ•˜äº‹å¼•æ“ã€‚ç³»çµ±ä¸åƒ…æ”¯æ´è¤‡é›œçš„åŠ‡æƒ…åˆ†æ”¯å’Œé¸æ“‡ç³»çµ±ï¼Œé‚„æä¾›äº†è±å¯Œçš„è¦–è¦ºå’ŒéŸ³æ•ˆé«”é©—ï¼ âœ¨