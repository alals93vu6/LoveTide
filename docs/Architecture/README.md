# 🏗️ 模組架構總覽

> LoveTide 專案的系統架構設計與模組整合說明

---

## 📁 架構文檔結構 (2025-07-30 完善)

### 🎮 **完整架構分類**
```
📁 Architecture/
├── 📋 README.md (本檔案 - 總導覽)
├── 💾 存檔系統架構.md (通用存檔系統)
├── 📊 數據流架構.md (核心資料流管理)
│
├── 📁 CoreSystems/ (核心系統技術架構)
│   ├── 🎭 劇情播放系統架構.md
│   └── 💖 養成互動系統架構.md
│
├── 📁 DataFlow/ (數據流架構專門)
│   └── 🌊 CoreSystems數據流架構.md
│
├── 📁 NurturingMode/ (養成模式專用)
│   ├── 🎮 養成遊戲流程.md
│   ├── 🎨 養成UI系統.md
│   ├── 👤 小Yuka移動系統.md
│   └── 🐱 貓咪互動系統.md
│
├── 📁 StoryMode/ (劇情模式專用)
│   ├── 🎬 劇情場景管理.md
│   └── 🖼️ CG展示系統.md
│
├── 📁 SharedSystems/ (共用系統)
│   ├── 💬 對話系統架構.md
│   ├── 🎭 演員控制架構.md
│   ├── 🎵 音效系統架構.md
│   ├── 🏠 主選單系統架構.md
│   └── 🖼️ CG觀賞大廳架構.md
│
├── 📁 AdultContentSystems/ (成人內容系統)
│   └── 🔞 成人內容系統架構.md
│
└── 📁 litleGame/ (小遊戲系統)
    ├── 📁 fishing/ (釣魚系統)
    │   └── 🎣 釣魚系統架構.md
    └── 📁 restaurant/ (餐廳系統)
        └── 🍽️ 餐廳系統架構.md
```

### 🚨 **重要架構更新通知**
> ⚠️ **演員系統大改動**: 角色偵測和演員控制部分將有重大調整，現有文檔僅供架構參考。

---

## 🎯 概述

LoveTide 採用**雙模式架構設計** (養成模式 + 劇情模式)，各系統間通過事件機制和統一的管理器進行通信，確保高內聚、低耦合的程式碼結構。經過架構重組，文檔按照遊戲模式分類，便於開發和維護。

---

## 🧱 核心架構層級

### 📊 系統層級結構
```
🎮 遊戲層 (Game Layer)
├── 🎭 劇情系統 (Drama System)
├── ❤️ 養成系統 (Relationship System)  
├── 🎣 小遊戲系統 (Mini-Game System)
└── 🔞 成人內容系統 (Adult Content System)

🏗️ 管理層 (Management Layer)
├── 🎯 遊戲管理器 (GameManager)
├── 🎵 音效管理器 (AudioManager)
├── 🖼️ UI 管理器 (UIManager)
└── 💾 存檔管理器 (SaveManager)

🔧 工具層 (Utility Layer)
├── 📡 事件總線 (EventBus)
├── 📊 數據管理 (DataManager)
├── ⏰ 時間系統 (TimeSystem)
└── 🎨 資源管理 (ResourceManager)
```

---

## 🔄 系統間通信

### 📡 事件驅動架構
```csharp
// 事件發布
EventBus.Instance.Publish("AffectionChanged", new AffectionData());

// 事件訂閱
EventBus.Instance.Subscribe<AffectionData>("AffectionChanged", OnAffectionChanged);
```

### 🎯 主要事件類型
- **遊戲狀態事件**: 場景切換、暫停、繼續
- **劇情事件**: 對話開始、結束、選擇分支
- **養成事件**: 好感度變化、等級提升
- **UI 事件**: 按鈕點擊、介面更新
- **音效事件**: 音樂切換、音效播放

---

## 🎮 主要系統模組

### 🎯 遊戲核心管理 (GameManager)
- **職責**: 統籌遊戲整體流程
- **管理範圍**: 場景切換、狀態控制、存檔載入
- **通信方式**: 中央調度器模式

### 🎭 劇情播放架構 (Drama System)  
- **組件**: `GamePlayingManagerDrama` + JSON 數據
- **流程**: 數據載入 → UI 顯示 → 動畫播放 → 用戶輸入
- **整合**: 與背景、音效、UI 系統協作

### ❤️ 養成互動架構 (Relationship System)
- **核心**: 時間管理 + 數值系統 + 條件判斷
- **數據流**: 選擇 → 條件檢查 → 數值更新 → UI 反饋
- **擴展性**: 支援多角色、多數值維度

---

## 📊 數據流架構

### 🔄 數據流向圖
```
用戶輸入 → 事件觸發 → 邏輯處理 → 數據更新 → UI 更新 → 持久化存儲
    ↑                                                           ↓
載入時數據恢復 ←─────────────────────────────────────────── 存檔系統
```

### 💾 數據分層
- **持久層**: PlayerPrefs、JSON 檔案
- **業務層**: 遊戲邏輯、數值計算
- **表現層**: UI 顯示、動畫播放
- **輸入層**: 用戶操作、事件觸發

---

## 🎨 UI 系統架構

### 📱 UI 層級結構
```
🖼️ UI Canvas 層級
├── HUD Layer (永久顯示)
│   └── 快捷按鈕
├── Dialog Layer (對話系統)
│   ├── 對話框
│   ├── 角色立繪
│   └── 選項按鈕
├── Menu Layer (選單系統)
│   ├── 主選單
│   ├── 設定選單
│   └── 存檔選單
└── Popup Layer (彈出視窗)
    ├── 確認對話框
    ├── 提示訊息
    └── 錯誤訊息
```

### 🎯 UI 管理策略
- **單例模式**: UIManager 統一管理所有 UI
- **棧式管理**: UI 面板採用堆疊管理
- **事件驅動**: UI 更新通過事件觸發
- **資源池**: 頻繁使用的 UI 元件使用對象池

---

## 🎵 音效系統架構

### 🔊 音效分類管理
```csharp
public enum AudioCategory
{
    BGM,        // 背景音樂
    SFX,        // 音效
    Voice,      // 語音
    Ambient     // 環境音
}
```

### 🎶 音效管理流程
1. **音效註冊**: 系統啟動時載入音效資源
2. **播放請求**: 通過事件系統請求播放
3. **音量控制**: 根據設定調整各類音效音量
4. **記憶體管理**: 動態載入/卸載音效資源

---

## ⏰ 時間系統架構

### 📅 時間管理層次
```csharp
public class TimeSystem
{
    public GameTime currentTime;      // 遊戲內時間
    public float timeScale;           // 時間倍率
    public bool isPaused;             // 是否暫停
    
    // 時間事件
    public UnityEvent<int> OnDayChanged;
    public UnityEvent<TimeOfDay> OnTimeOfDayChanged;
}
```

### 🔄 時間相關系統
- **劇情系統**: 特定時間觸發事件
- **養成系統**: 時間消耗和冷卻機制
- **小遊戲**: 時間限制和獎勵系統
- **存檔系統**: 時間戳記錄

---

## 💾 存檔系統架構

### 📋 存檔數據結構
```json
{
    "gameVersion": "1.0.0",
    "saveTime": "2025-07-15T10:30:00",
    "gameProgress": {
        "currentScene": "main_room",
        "dramaProgress": 15,
        "affectionLevel": 65
    },
    "gameData": {
        "playerMoney": 5000,
        "fishingLevel": 8,
        "unlockedContent": ["fishing", "dating"]
    }
}
```

### 🛡 存檔安全機制
- **版本檢查**: 檢查存檔兼容性
- **數據驗證**: 防止數據篡改
- **備份機制**: 自動備份重要存檔
- **錯誤恢復**: 存檔損壞時的恢復機制

---

## 🔌 擴展性設計

### 🧩 模組化原則
- **接口導向**: 使用接口定義系統間契約
- **依賴注入**: 減少系統間的硬耦合
- **配置驅動**: 通過配置文件控制系統行為
- **插件架構**: 支援功能模組的動態載入

### 🎯 未來擴展點
- **多語言支援**: 國際化架構設計
- **雲端存檔**: 雲端同步功能
- **MOD 支援**: 用戶自定義內容
- **多平台適配**: 不同平台的適配層

---

---

## 🔄 **LoveTide 數據流循環架構導覽**

> 🎯 **核心理念**: LoveTide 採用樹狀迴圈數據結構，實現進度偵測 → JSON選擇 → 玩家觸發 → 狀態更新 → 劇情導向的完整循環

### 📊 **數據流循環總覽**
```
🎮 遊戲啟動
    ↓
📊 進度偵測 (ProgressDetector)
    ├── 讀取存檔進度 → SaveDataManager
    ├── 分析當前章節 → 決定JSON路徑
    └── 檢查劇情觸發條件
    ↓
📁 JSON數據載入 (JsonDataManager)
    ├── 載入對話文本 → DialogData
    ├── 載入養成數據 → RelationshipData  
    └── 載入劇情條件 → StoryTriggers
    ↓
🎮 養成模式遊戲循環
    ├── 🖱️ 玩家點擊觸發 → InteractionManager
    ├── 📊 數值更新 → NumericalRecords
    ├── ⏰ 時間推進 → TimeManagerTest
    └── 🎯 條件檢查 → 是否觸發劇情？
    ↓
🎭 劇情模式 (條件滿足時)
    ├── 載入劇情JSON → GamePlayingManagerDrama
    ├── 播放劇情對話 → TextBoxDrama
    ├── 演員表情控制 → ActorManagerDrama
    └── 更新遊戲進度 → 回到進度偵測
    ↓
🔄 循環重複...
```

### 🎯 **核心數據流文件導覽**

#### 📋 **1. 數據流架構核心**
- **主要文件**: [`數據流架構.md`](./數據流架構.md)
- **關鍵概念**: JSON驅動、進度偵測、數據分發
- **相關文件**: [`遊戲流程架構.md`](./遊戲流程架構.md)

#### 🎮 **2. 玩家觸發機制**  
- **主要文件**: [`UI架構設計.md`](./UI架構設計.md) 
- **關鍵概念**: 互動檢測、事件觸發、狀態管理
- **相關文件**: [`演員控制架構.md`](./演員控制架構.md)

#### 📊 **3. 數值與進度管理**
- **主要文件**: [`數據流架構.md`](./數據流架構.md) + [`遊戲流程架構.md`](./遊戲流程架構.md)
- **關鍵概念**: NumericalRecords、SaveDataManager、進度偵測
- **程式模組**: 參考 [`CodeModules/README.md`](../CodeModules/README.md)

#### 🎭 **4. 劇情觸發與播放**
- **主要文件**: [`TextBox對話系統.md`](./TextBox對話系統.md)
- **關鍵概念**: 條件檢查、劇情載入、對話展示  
- **相關文件**: [`演員控制架構.md`](./演員控制架構.md)、[`音效系統架構.md`](./音效系統架構.md)

---

## 📚 **架構文件閱讀路徑**

### 🎯 **新手入門路徑** (理解整體概念)
1. **本檔案** (README.md) - 架構總覽
2. [`數據流架構.md`](./數據流架構.md) - 核心數據循環
3. [`遊戲流程架構.md`](./遊戲流程架構.md) - 遊戲狀態管理
4. [`演員控制架構.md`](./演員控制架構.md) - 角色系統

### 🔧 **開發實作路徑** (深入技術細節)
1. [`數據流架構.md`](./數據流架構.md) - 了解JSON驅動機制
2. [`UI架構設計.md`](./UI架構設計.md) - 互動檢測實作
3. [`TextBox對話系統.md`](./TextBox對話系統.md) - 對話系統實作
4. [`音效系統架構.md`](./音效系統架構.md) - 音效整合

### 🎮 **功能維護路徑** (特定系統修改)
- **養成系統**: [`演員控制架構.md`](./演員控制架構.md) → [`小Yuka移動系統.md`](./小Yuka移動系統.md) → [`UI架構設計.md`](./UI架構設計.md)
- **劇情系統**: [`數據流架構.md`](./數據流架構.md) → [`TextBox對話系統.md`](./TextBox對話系統.md) → [`演員控制架構.md`](./演員控制架構.md)
- **互動系統**: [`UI架構設計.md`](./UI架構設計.md) → [`遊戲流程架構.md`](./遊戲流程架構.md)

---

## 🔗 **系統間依賴關係**

### 📊 **高依賴度系統** (修改影響大)
- **數據流架構** ← 所有系統都依賴
- **遊戲流程架構** ← UI、演員、音效系統依賴
- **演員控制架構** ← 對話、移動系統依賴

### 🔧 **中依賴度系統** (部分影響)
- **UI架構設計** ← 互動、對話系統依賴
- **音效系統架構** ← 遊戲流程、對話系統依賴

### ⭐ **低依賴度系統** (相對獨立)
- **TextBox對話系統** - 主要被其他系統調用
- **小Yuka移動系統** - 相對獨立的背景系統

---

## 💬 Claude 使用提示

### 🎯 **根據任務選擇閱讀路徑**
- **理解整體架構**: 新手入門路徑
- **開發新功能**: 開發實作路徑  
- **修改現有功能**: 功能維護路徑
- **debug問題**: 先確認系統依賴關係

### ⚠️ **修改架構前必讀**
1. **檢查依賴關係** - 確認修改影響範圍
2. **閱讀相關文件** - 理解系統間的協作
3. **考慮數據流循環** - 確保不破壞核心循環
4. **更新交叉引用** - 同步更新相關文件
5. **驗證實機效果** - 確保與實機畫面一致

### 🔄 **數據流循環關鍵檢查點**
- **進度偵測是否正確** → 影響JSON載入
- **JSON數據是否完整** → 影響遊戲內容  
- **玩家觸發是否響應** → 影響互動體驗
- **劇情條件是否準確** → 影響劇情播放
- **數值更新是否同步** → 影響遊戲進度

---

## 🗂️ **新架構文檔導覽** (2025-07-29 重組後)

### 🎮 **養成模式架構**
- **🎮 養成遊戲流程**: [`NurturingMode/養成遊戲流程.md`](./NurturingMode/養成遊戲流程.md) - 養成模式的完整遊戲循環
- **🎨 養成UI系統**: [`NurturingMode/養成UI系統.md`](./NurturingMode/養成UI系統.md) - 養成模式的UI互動系統
- **👤 小Yuka移動系統**: [`NurturingMode/小Yuka移動系統.md`](./NurturingMode/小Yuka移動系統.md) - 主角移動與動畫系統

### 🎬 **劇情模式架構**
- **🎬 劇情場景管理**: [`StoryMode/劇情場景管理.md`](./StoryMode/劇情場景管理.md) - 劇情模式的場景控制與多角色支援
- **🖼️ CG展示系統**: [`StoryMode/CG展示系統.md`](./StoryMode/CG展示系統.md) - CG場景展示與視覺效果管理

### 🎯 **核心系統技術架構** (NEW!)
- **🎭 劇情播放系統架構**: [`CoreSystems/劇情播放系統架構.md`](./CoreSystems/劇情播放系統架構.md) - 完整的劇情播放引擎與對話管理系統
- **💖 養成互動系統架構**: [`CoreSystems/養成互動系統架構.md`](./CoreSystems/養成互動系統架構.md) - 數值管理、互動處理與時間系統整合

### 🌊 **數據流架構專門** (NEW!)
- **🌊 CoreSystems數據流架構**: [`DataFlow/CoreSystems數據流架構.md`](./DataFlow/CoreSystems數據流架構.md) - 劇情與養成系統間的事件驅動數據流設計

### 🔗 **共用系統架構**
- **💬 對話系統架構**: [`SharedSystems/對話系統架構.md`](./SharedSystems/對話系統架構.md) - 雙重對話系統 (養成+劇情)
- **🎭 演員控制架構**: [`SharedSystems/演員控制架構.md`](./SharedSystems/演員控制架構.md) - 角色表情與動畫控制 ⚠️
- **🎵 音效系統架構**: [`SharedSystems/音效系統架構.md`](./SharedSystems/音效系統架構.md) - 音效播放與管理
- **🏠 主選單系統架構**: [`SharedSystems/主選單系統架構.md`](./SharedSystems/主選單系統架構.md) - 三周目支援的智能入口系統
- **🖼️ CG觀賞大廳架構**: [`SharedSystems/CG觀賞大廳架構.md`](./SharedSystems/CG觀賞大廳架構.md) - JSON驅動的CG收藏館系統

### 🎮 **小遊戲系統架構**
- **🎣 釣魚系統架構**: [`litleGame/fishing/釣魚系統架構.md`](./litleGame/fishing/釣魚系統架構.md) - 釣魚小遊戲的完整技術實現
- **🍽️ 餐廳系統架構**: [`litleGame/restaurant/餐廳系統架構.md`](./litleGame/restaurant/餐廳系統架構.md) - 餐廳經營小遊戲系統

### 🔞 **成人內容系統架構** (NEW!)
- **🔞 成人內容系統架構**: [`AdultContentSystems/成人內容系統架構.md`](./AdultContentSystems/成人內容系統架構.md) - 節拍同步動畫、三大姿勢系統、多階段語音與結算系統的完整架構設計

### 📊 **基礎架構系統**
- **💾 存檔系統架構**: [`存檔系統架構.md`](./存檔系統架構.md) - JSON驅動存檔與6槽位管理
- **📊 數據流架構**: [`數據流架構.md`](./數據流架構.md) - 樹狀迴圈數據結構與JSON驅動

### 🚨 **重要提醒**
> ⚠️ **演員系統大改動**: 標記 ⚠️ 的系統將有重大架構調整，文檔僅供現有架構參考。

---

**最後更新**: 2025-08-05  
**版本**: 5.0 (完整架構體系)  
**維護者**: 開發團隊 + Claude AI

> 🏗️ **架構完善完成**: LoveTide 架構文檔已完成所有核心系統的技術架構補充，包含劇情播放、養成互動、數據流管理和成人內容系統等完整功能架構。新增成人內容系統採用創新的節拍同步機制和模組化設計，實現了從 GameMechanics 到 Architecture 的完整技術文檔體系。