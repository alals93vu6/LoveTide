# ğŸ½ï¸ é¤å»³ç³»çµ±ç¨‹å¼æ¶æ§‹

> åŸºæ–¼å¤šç‹€æ…‹æ©Ÿå’Œæ™‚é–“ç®¡ç†çš„é¤å»³ç¶“ç‡Ÿå°éŠæˆ²ç¨‹å¼æ¶æ§‹è¨­è¨ˆï¼Œæ•´åˆé•·å‹•ä½œç³»çµ±ã€å®¢äººAIå’Œå³æ™‚è©•åˆ†æ©Ÿåˆ¶

---

## ğŸ§© ç³»çµ±æ¦‚è¦½

### ğŸ¯ æ ¸å¿ƒè¨­è¨ˆç†å¿µ
- **å¤šç‹€æ…‹æ©Ÿå”ä½œ**: å®¢äººã€ç©å®¶ã€å·¥è®€ç”Ÿå„è‡ªç¨ç«‹çš„ç‹€æ…‹æ©Ÿç³»çµ±
- **æ™‚é–“é©…å‹•æ¶æ§‹**: åŸºæ–¼90ç§’å€’æ•¸çš„åš´æ ¼æ™‚é–“ç®¡ç†
- **äº‹ä»¶é©…å‹•è¨­è¨ˆ**: æ‰€æœ‰äº’å‹•é€éäº‹ä»¶ç³»çµ±è§£è€¦åˆ
- **é•·å‹•ä½œç®¡ç†**: å¯ä¸­æ–·ã€å¯æ¢å¾©çš„æ“ä½œç³»çµ±

### ğŸ“¦ ä¸»è¦æ¨¡çµ„çµ„æˆ
```
RestaurantSystem/
â”œâ”€â”€ Core/                       # æ ¸å¿ƒç³»çµ±
â”‚   â”œâ”€â”€ RestaurantManager       # ä¸»æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ GameTimer               # éŠæˆ²è¨ˆæ™‚å™¨
â”‚   â””â”€â”€ EventSystem/            # äº‹ä»¶ç®¡ç†ç³»çµ±
â”œâ”€â”€ Actors/                     # è§’è‰²ç³»çµ±
â”‚   â”œâ”€â”€ Player/                 # ç©å®¶æ§åˆ¶
â”‚   â”œâ”€â”€ Customer/               # å®¢äººAIç³»çµ±
â”‚   â””â”€â”€ Staff/                  # å·¥è®€ç”ŸAIç³»çµ±
â”œâ”€â”€ Actions/                    # å‹•ä½œç³»çµ±
â”‚   â”œâ”€â”€ LongActionSystem/       # é•·å‹•ä½œç®¡ç†
â”‚   â”œâ”€â”€ ActionQueue/            # å‹•ä½œä½‡åˆ—
â”‚   â””â”€â”€ ProgressSystem/         # é€²åº¦ç®¡ç†
â”œâ”€â”€ Environment/                # ç’°å¢ƒç³»çµ±
â”‚   â”œâ”€â”€ Tables/                 # é¤æ¡Œç®¡ç†
â”‚   â”œâ”€â”€ Counter/                # æ«ƒå°ç³»çµ±
â”‚   â””â”€â”€ SelfService/            # è‡ªåŠ©å€ç®¡ç†
â”œâ”€â”€ Scoring/                    # è©•åˆ†ç³»çµ±
â”‚   â”œâ”€â”€ ScoreCalculator/        # åˆ†æ•¸è¨ˆç®—
â”‚   â”œâ”€â”€ CustomerSatisfaction/   # å®¢äººæ»¿æ„åº¦
â”‚   â””â”€â”€ MultiplierSystem/       # å€ç‡ç³»çµ±
â””â”€â”€ UI/                         # ç”¨æˆ¶ç•Œé¢
    â”œâ”€â”€ GameHUD/                # éŠæˆ²ä¸»ä»‹é¢
    â”œâ”€â”€ ActionProgress/         # å‹•ä½œé€²åº¦æ¢
    â””â”€â”€ ScoreDisplay/           # åˆ†æ•¸é¡¯ç¤º
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ§‹è¨­è¨ˆ

### ğŸ® ä¸»æ§åˆ¶å™¨ (RestaurantManager)

```csharp
public class RestaurantManager : MonoBehaviour, IGameSystem
{
    [Header("ç³»çµ±ç®¡ç†å™¨")]
    public GameTimer gameTimer;                     // éŠæˆ²è¨ˆæ™‚å™¨
    public CustomerManager customerManager;         // å®¢äººç®¡ç†å™¨
    public StaffManager staffManager;               // å·¥è®€ç”Ÿç®¡ç†å™¨
    public PlayerController playerController;       // ç©å®¶æ§åˆ¶å™¨
    public LongActionManager actionManager;         // é•·å‹•ä½œç®¡ç†å™¨
    public RestaurantScoring scoringSystem;         // è©•åˆ†ç³»çµ±
    
    [Header("éŠæˆ²ç‹€æ…‹")]
    public RestaurantGameState currentState;       // ç•¶å‰éŠæˆ²ç‹€æ…‹
    public StaffConfiguration staffConfig;          // å·¥è®€ç”Ÿé…ç½®
    public float currentMultiplier;                 // ç•¶å‰åˆ†æ•¸å€ç‡
    public int remainingActionPoints;               // å‰©é¤˜è¡Œå‹•é»
    
    [Header("ç’°å¢ƒç®¡ç†")]
    public TableManager tableManager;              // é¤æ¡Œç®¡ç†å™¨
    public CounterManager counterManager;          // æ«ƒå°ç®¡ç†å™¨
    public SelfServiceManager selfServiceManager; // è‡ªåŠ©å€ç®¡ç†å™¨
    
    // ç³»çµ±åˆå§‹åŒ–
    public void InitializeRestaurant(int actionPoints, StaffConfiguration config)
    {
        // è¨­ç½®åŸºæœ¬åƒæ•¸
        remainingActionPoints = actionPoints;
        staffConfig = config;
        currentMultiplier = CalculateMultiplier(config);
        
        // åˆå§‹åŒ–å„å€‹å­ç³»çµ±
        InitializeSubSystems();
        
        // è¨­ç½®éŠæˆ²ç‹€æ…‹
        currentState = RestaurantGameState.Setup;
        
        // é–‹å§‹éŠæˆ²å€’æ•¸
        StartGameCountdown();
    }
    
    // éŠæˆ²ä¸»å¾ªç’°
    void Update()
    {
        switch (currentState)
        {
            case RestaurantGameState.Setup:
                HandleSetupPhase();
                break;
            case RestaurantGameState.Playing:
                HandleGameplayPhase();
                break;
            case RestaurantGameState.Settlement:
                HandleSettlementPhase();
                break;
        }
    }
    
    // éŠæˆ²ç©æ³•éšæ®µè™•ç†
    private void HandleGameplayPhase()
    {
        // æ›´æ–°è¨ˆæ™‚å™¨
        gameTimer.UpdateTimer();
        
        // æª¢æŸ¥éŠæˆ²çµæŸæ¢ä»¶
        if (gameTimer.IsTimeUp())
        {
            EndGame();
        }
        
        // æ›´æ–°å„å€‹ç³»çµ±
        customerManager.UpdateCustomers();
        staffManager.UpdateStaff();
        actionManager.UpdateActions();
    }
    
    // éŠæˆ²çµæŸè™•ç†
    private void EndGame()
    {
        currentState = RestaurantGameState.Settlement;
        
        // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
        int finalScore = scoringSystem.CalculateFinalScore(
            customerManager.GetAllCustomers(), 
            currentMultiplier
        );
        
        // è§¸ç™¼çµç®—äº‹ä»¶
        EventSystem.Instance.TriggerEvent("GameEnded", finalScore);
    }
}
```

### â° éŠæˆ²è¨ˆæ™‚å™¨ç³»çµ±

```csharp
public class GameTimer : MonoBehaviour
{
    [Header("æ™‚é–“è¨­å®š")]
    public float gameDuration = 90f;               // éŠæˆ²ç¸½æ™‚é•·
    public float currentTime;                      // ç•¶å‰å‰©é¤˜æ™‚é–“
    public bool isRunning = false;                 // è¨ˆæ™‚å™¨æ˜¯å¦é‹è¡Œ
    
    [Header("æ™‚é–“äº‹ä»¶")]
    public UnityEvent<float> OnTimeUpdated;        // æ™‚é–“æ›´æ–°äº‹ä»¶
    public UnityEvent OnTimeUp;                    // æ™‚é–“çµæŸäº‹ä»¶
    public UnityEvent<float> OnTimeWarning;        // æ™‚é–“è­¦å‘Šäº‹ä»¶
    
    // é–‹å§‹è¨ˆæ™‚
    public void StartTimer()
    {
        currentTime = gameDuration;
        isRunning = true;
    }
    
    // æ›´æ–°è¨ˆæ™‚å™¨
    public void UpdateTimer()
    {
        if (!isRunning) return;
        
        currentTime -= Time.deltaTime;
        OnTimeUpdated?.Invoke(currentTime);
        
        // æ™‚é–“è­¦å‘Š (å‰©é¤˜30ç§’)
        if (currentTime <= 30f && currentTime > 29f)
        {
            OnTimeWarning?.Invoke(currentTime);
        }
        
        // æ™‚é–“çµæŸ
        if (currentTime <= 0f)
        {
            currentTime = 0f;
            isRunning = false;
            OnTimeUp?.Invoke();
        }
    }
    
    // æš«åœ/æ¢å¾©è¨ˆæ™‚
    public void PauseTimer() => isRunning = false;
    public void ResumeTimer() => isRunning = true;
    
    // ç²å–æ™‚é–“è³‡è¨Š
    public bool IsTimeUp() => currentTime <= 0f;
    public float GetRemainingTime() => currentTime;
    public float GetElapsedTime() => gameDuration - currentTime;
    public float GetTimeRatio() => currentTime / gameDuration;
}
```

---

## ğŸ‘¥ è§’è‰²ç³»çµ±æ¶æ§‹

### ğŸš¶ å®¢äººAIç³»çµ±

```csharp
// å®¢äººç‹€æ…‹æ©Ÿ
public class Customer : MonoBehaviour
{
    [Header("å®¢äººè³‡è¨Š")]
    public string customerID;                      // å®¢äººID
    public CustomerType customerType;              // å®¢äººé¡å‹
    public Vector2 currentPosition;                // ç•¶å‰ä½ç½®
    public Table assignedTable;                    // åˆ†é…çš„é¤æ¡Œ
    
    [Header("ç‹€æ…‹ç®¡ç†")]
    public CustomerState currentState;             // ç•¶å‰ç‹€æ…‹
    public StateMachine<Customer> stateMachine;    // ç‹€æ…‹æ©Ÿ
    
    [Header("è€å¿ƒç³»çµ±")]
    public float maxPatience = 60f;               // æœ€å¤§è€å¿ƒå€¼
    public float currentPatience;                 // ç•¶å‰è€å¿ƒå€¼
    public float patienceDecayRate = 1f;          // è€å¿ƒæ¶ˆè€—é€Ÿåº¦
    
    [Header("è¨‚å–®è³‡è¨Š")]
    public Order customerOrder;                   // å®¢äººè¨‚å–®
    public bool hasOrdered = false;               // æ˜¯å¦å·²é»é¤
    public bool foodServed = false;               // æ˜¯å¦å·²ä¸Šèœ
    
    [Header("æ»¿æ„åº¦ç³»çµ±")]
    public CustomerSatisfaction satisfaction;      // æ»¿æ„åº¦ç®¡ç†
    
    void Start()
    {
        InitializeCustomer();
        SetupStateMachine();
    }
    
    void Update()
    {
        stateMachine.Update();
        UpdatePatience();
        CheckLeaveConditions();
    }
    
    // åˆå§‹åŒ–å®¢äºº
    private void InitializeCustomer()
    {
        customerID = System.Guid.NewGuid().ToString();
        currentPatience = maxPatience;
        satisfaction = new CustomerSatisfaction();
        currentState = CustomerState.Queuing;
    }
    
    // è¨­ç½®ç‹€æ…‹æ©Ÿ
    private void SetupStateMachine()
    {
        stateMachine = new StateMachine<Customer>(this);
        
        // è¨»å†Šæ‰€æœ‰ç‹€æ…‹
        stateMachine.AddState(CustomerState.Queuing, new CustomerQueuingState());
        stateMachine.AddState(CustomerState.Ordering, new CustomerOrderingState());
        stateMachine.AddState(CustomerState.FindingSeat, new CustomerFindingSeatState());
        stateMachine.AddState(CustomerState.SelfService, new CustomerSelfServiceState());
        stateMachine.AddState(CustomerState.WaitingFood, new CustomerWaitingFoodState());
        stateMachine.AddState(CustomerState.Eating, new CustomerEatingState());
        stateMachine.AddState(CustomerState.Checkout, new CustomerCheckoutState());
        stateMachine.AddState(CustomerState.Leaving, new CustomerLeavingState());
        
        // é–‹å§‹ç‹€æ…‹æ©Ÿ
        stateMachine.Start(CustomerState.Queuing);
    }
    
    // æ›´æ–°è€å¿ƒå€¼
    private void UpdatePatience()
    {
        if (currentState == CustomerState.Leaving || 
            currentState == CustomerState.Checkout) return;
        
        float decayMultiplier = GetPatienceDecayMultiplier();
        currentPatience -= patienceDecayRate * decayMultiplier * Time.deltaTime;
        currentPatience = Mathf.Max(0, currentPatience);
    }
    
    // æª¢æŸ¥é›¢é–‹æ¢ä»¶
    private void CheckLeaveConditions()
    {
        if (currentPatience <= 0 && currentState != CustomerState.Leaving)
        {
            // è€å¿ƒè€—ç›¡ï¼Œå¼·åˆ¶é›¢é–‹
            satisfaction.RecordEarlyLeave("Patience exhausted");
            stateMachine.ChangeState(CustomerState.Leaving);
        }
    }
}

// å®¢äººç‹€æ…‹ï¼šæ’éšŠç­‰å¾…
public class CustomerQueuingState : IState<Customer>
{
    public void OnEnter(Customer customer)
    {
        // åŠ å…¥æ«ƒå°æ’éšŠéšŠåˆ—
        CounterManager.Instance.AddToQueue(customer);
        
        // è¨­ç½®è¼ƒé«˜çš„è€å¿ƒæ¶ˆè€—ç‡
        customer.patienceDecayRate = 1.2f;
    }
    
    public void OnUpdate(Customer customer)
    {
        // æª¢æŸ¥æ˜¯å¦è¼ªåˆ°é»é¤
        if (CounterManager.Instance.IsCustomerTurn(customer))
        {
            customer.stateMachine.ChangeState(CustomerState.Ordering);
        }
        
        // æª¢æŸ¥ç­‰å¾…æ™‚é–“éä¹…
        if (customer.GetQueueWaitTime() > 30f)
        {
            customer.satisfaction.AddPenalty(-5, "Long queue wait");
        }
    }
    
    public void OnExit(Customer customer)
    {
        CounterManager.Instance.RemoveFromQueue(customer);
    }
}

// å®¢äººç‹€æ…‹ï¼šé»é¤ä¸­
public class CustomerOrderingState : IState<Customer>
{
    private float orderingTime = 0f;
    private const float MAX_ORDERING_TIME = 10f;
    
    public void OnEnter(Customer customer)
    {
        orderingTime = 0f;
        customer.patienceDecayRate = 0.5f;  // é»é¤æ™‚è€å¿ƒæ¶ˆè€—è¼ƒæ…¢
        
        // ç”Ÿæˆè¨‚å–®
        customer.customerOrder = OrderGenerator.GenerateOrder(customer.customerType);
    }
    
    public void OnUpdate(Customer customer)
    {
        orderingTime += Time.deltaTime;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ«ƒå°äººå“¡è™•ç†
        if (StaffManager.Instance.HasCounterStaff())
        {
            // å·¥è®€ç”Ÿè‡ªå‹•è™•ç†
            ProcessOrderAutomatically(customer);
        }
        else
        {
            // ç­‰å¾…ç©å®¶è™•ç†
            if (PlayerController.Instance.IsInteractingWith(customer))
            {
                ProcessOrderWithPlayer(customer);
            }
        }
        
        // è¶…æ™‚æª¢æŸ¥
        if (orderingTime > MAX_ORDERING_TIME)
        {
            customer.satisfaction.AddPenalty(-3, "Ordering timeout");
            CompleteOrder(customer);
        }
    }
    
    private void CompleteOrder(Customer customer)
    {
        customer.hasOrdered = true;
        customer.stateMachine.ChangeState(CustomerState.FindingSeat);
    }
}
```

### ğŸ‘¨â€ğŸ’¼ å·¥è®€ç”ŸAIç³»çµ±

```csharp
// å·¥è®€ç”Ÿç®¡ç†å™¨
public class StaffManager : MonoBehaviour
{
    [Header("å·¥è®€ç”Ÿé…ç½®")]
    public StaffConfiguration currentConfig;       // ç•¶å‰å·¥è®€ç”Ÿé…ç½®
    
    [Header("å·¥è®€ç”Ÿå¯¦ä¾‹")]
    public CounterStaff counterStaff;             // æ«ƒå°äººå“¡
    public ServiceStaff serviceStaff;             // æœå‹™äººå“¡
    public SupplyStaff supplyStaff;               // è£œè²¨äººå“¡
    
    // åˆå§‹åŒ–å·¥è®€ç”Ÿ
    public void InitializeStaff(StaffConfiguration config)
    {
        currentConfig = config;
        
        // æ ¹æ“šé…ç½®å•Ÿç”¨å°æ‡‰å·¥è®€ç”Ÿ
        if (config.hasCounterStaff)
        {
            counterStaff.gameObject.SetActive(true);
            counterStaff.Initialize();
        }
        
        if (config.hasServiceStaff)
        {
            serviceStaff.gameObject.SetActive(true);
            serviceStaff.Initialize();
        }
        
        if (config.hasSupplyStaff)
        {
            supplyStaff.gameObject.SetActive(true);
            supplyStaff.Initialize();
        }
    }
    
    // æ›´æ–°æ‰€æœ‰å·¥è®€ç”Ÿ
    public void UpdateStaff()
    {
        if (counterStaff.isActiveAndEnabled)
            counterStaff.UpdateAI();
            
        if (serviceStaff.isActiveAndEnabled)
            serviceStaff.UpdateAI();
            
        if (supplyStaff.isActiveAndEnabled)
            supplyStaff.UpdateAI();
    }
}

// æ«ƒå°å·¥è®€ç”Ÿ
public class CounterStaff : MonoBehaviour
{
    [Header("AIç‹€æ…‹")]
    public StaffState currentState = StaffState.Idle;
    public Customer currentCustomer;               // ç•¶å‰æœå‹™çš„å®¢äºº
    
    [Header("æ•ˆç‡åƒæ•¸")]
    public float processingSpeed = 0.8f;          // è™•ç†æ•ˆç‡
    public float processingTime = 0f;             // ç•¶å‰è™•ç†æ™‚é–“
    
    public void UpdateAI()
    {
        switch (currentState)
        {
            case StaffState.Idle:
                CheckForWaitingCustomers();
                break;
            case StaffState.Processing:
                ProcessCurrentCustomer();
                break;
        }
    }
    
    private void CheckForWaitingCustomers()
    {
        Customer nextCustomer = CounterManager.Instance.GetNextCustomer();
        if (nextCustomer != null)
        {
            currentCustomer = nextCustomer;
            currentState = StaffState.Processing;
            processingTime = 0f;
        }
    }
    
    private void ProcessCurrentCustomer()
    {
        processingTime += Time.deltaTime * processingSpeed;
        
        // æ¨¡æ“¬é»é¤è™•ç†æ™‚é–“
        float requiredTime = currentCustomer.customerOrder.GetProcessingTime();
        
        if (processingTime >= requiredTime)
        {
            // å®Œæˆé»é¤
            currentCustomer.CompleteOrder();
            currentCustomer = null;
            currentState = StaffState.Idle;
        }
    }
}
```

---

## ğŸ› ï¸ é•·å‹•ä½œç³»çµ±æ¶æ§‹

### ğŸ“‹ é•·å‹•ä½œç®¡ç†å™¨

```csharp
public class LongActionManager : MonoBehaviour
{
    [Header("ç•¶å‰å‹•ä½œ")]
    public LongAction currentAction;              // ç•¶å‰åŸ·è¡Œçš„é•·å‹•ä½œ
    public bool isPerformingAction = false;       // æ˜¯å¦æ­£åœ¨åŸ·è¡Œå‹•ä½œ
    
    [Header("å‹•ä½œéšŠåˆ—")]
    public Queue<LongAction> actionQueue;         // å‹•ä½œéšŠåˆ—
    public int maxQueueSize = 3;                  // æœ€å¤§éšŠåˆ—å¤§å°
    
    [Header("UIé¡¯ç¤º")]
    public ActionProgressUI progressUI;           // é€²åº¦æ¢UI
    
    // é–‹å§‹åŸ·è¡Œé•·å‹•ä½œ
    public bool StartLongAction(LongActionType actionType, GameObject target)
    {
        if (isPerformingAction) return false;
        
        // å‰µå»ºé•·å‹•ä½œå¯¦ä¾‹
        LongAction newAction = CreateLongAction(actionType, target);
        if (newAction == null) return false;
        
        // é–‹å§‹åŸ·è¡Œ
        currentAction = newAction;
        isPerformingAction = true;
        
        // é¡¯ç¤ºé€²åº¦æ¢
        progressUI.ShowProgress(newAction);
        
        // è§¸ç™¼é–‹å§‹äº‹ä»¶
        EventSystem.Instance.TriggerEvent("ActionStarted", newAction);
        
        return true;
    }
    
    // æ›´æ–°é•·å‹•ä½œé€²åº¦
    public void UpdateActions()
    {
        if (!isPerformingAction || currentAction == null) return;
        
        // æ›´æ–°å‹•ä½œé€²åº¦
        currentAction.UpdateProgress();
        progressUI.UpdateProgress(currentAction.GetProgress());
        
        // æª¢æŸ¥å‹•ä½œå®Œæˆ
        if (currentAction.IsCompleted())
        {
            CompleteCurrentAction();
        }
        
        // æª¢æŸ¥å‹•ä½œä¸­æ–·
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            InterruptCurrentAction();
        }
    }
    
    // å®Œæˆç•¶å‰å‹•ä½œ
    private void CompleteCurrentAction()
    {
        // åŸ·è¡Œå‹•ä½œæ•ˆæœ
        currentAction.ExecuteEffect();
        
        // è§¸ç™¼å®Œæˆäº‹ä»¶
        EventSystem.Instance.TriggerEvent("ActionCompleted", currentAction);
        
        // æ¸…ç†ç•¶å‰å‹•ä½œ
        CleanupCurrentAction();
        
        // è™•ç†éšŠåˆ—ä¸­çš„ä¸‹ä¸€å€‹å‹•ä½œ
        ProcessNextAction();
    }
    
    // ä¸­æ–·ç•¶å‰å‹•ä½œ
    private void InterruptCurrentAction()
    {
        if (currentAction != null)
        {
            // ä¿å­˜é€²åº¦
            currentAction.SaveProgress();
            
            // è§¸ç™¼ä¸­æ–·äº‹ä»¶
            EventSystem.Instance.TriggerEvent("ActionInterrupted", currentAction);
        }
        
        CleanupCurrentAction();
    }
    
    // å‰µå»ºé•·å‹•ä½œå¯¦ä¾‹
    private LongAction CreateLongAction(LongActionType actionType, GameObject target)
    {
        switch (actionType)
        {
            case LongActionType.TakeOrder:
                return new TakeOrderAction(target.GetComponent<Customer>());
            case LongActionType.ServeFood:
                return new ServeFoodAction(target.GetComponent<Table>());
            case LongActionType.CleanTable:
                return new CleanTableAction(target.GetComponent<Table>());
            case LongActionType.RefillSupplies:
                return new RefillSuppliesAction(target.GetComponent<SupplyStation>());
            default:
                return null;
        }
    }
}

// é•·å‹•ä½œåŸºé¡
public abstract class LongAction
{
    [Header("åŸºæœ¬è³‡è¨Š")]
    public string actionName;                     // å‹•ä½œåç¨±
    public LongActionType actionType;             // å‹•ä½œé¡å‹
    public float totalTime;                       // ç¸½åŸ·è¡Œæ™‚é–“
    public float currentProgress;                 // ç•¶å‰é€²åº¦ (0-1)
    public bool isInterrupted = false;            // æ˜¯å¦è¢«ä¸­æ–·
    
    [Header("ç›®æ¨™ç‰©ä»¶")]
    public GameObject targetObject;               // ç›®æ¨™ç‰©ä»¶
    
    protected float startTime;                    // é–‹å§‹æ™‚é–“
    
    // æ§‹é€ å‡½æ•¸
    public LongAction(LongActionType type, float duration, GameObject target)
    {
        actionType = type;
        totalTime = duration;
        targetObject = target;
        currentProgress = 0f;
        startTime = Time.time;
    }
    
    // æ›´æ–°é€²åº¦
    public virtual void UpdateProgress()
    {
        float elapsedTime = Time.time - startTime;
        currentProgress = Mathf.Clamp01(elapsedTime / totalTime);
    }
    
    // åŸ·è¡Œå‹•ä½œæ•ˆæœ
    public abstract void ExecuteEffect();
    
    // ä¿å­˜é€²åº¦
    public virtual void SaveProgress()
    {
        PlayerPrefs.SetFloat($"Action_{actionType}_Progress", currentProgress);
    }
    
    // æ¢å¾©é€²åº¦
    public virtual void RestoreProgress()
    {
        if (PlayerPrefs.HasKey($"Action_{actionType}_Progress"))
        {
            currentProgress = PlayerPrefs.GetFloat($"Action_{actionType}_Progress");
            startTime = Time.time - (currentProgress * totalTime);
        }
    }
    
    // æª¢æŸ¥æ˜¯å¦å®Œæˆ
    public bool IsCompleted() => currentProgress >= 1f;
    
    // ç²å–é€²åº¦
    public float GetProgress() => currentProgress;
    
    // ç²å–å‰©é¤˜æ™‚é–“
    public float GetRemainingTime() => totalTime * (1f - currentProgress);
}

// é»é¤å‹•ä½œ
public class TakeOrderAction : LongAction
{
    private Customer customer;
    
    public TakeOrderAction(Customer target) : base(LongActionType.TakeOrder, 4f, target.gameObject)
    {
        customer = target;
        actionName = $"ç‚ºå®¢äººé»é¤";
        
        // æ ¹æ“šç©å®¶å‡ç´šèª¿æ•´æ™‚é–“
        float speedBonus = PlayerUpgradeManager.Instance.GetActionSpeedMultiplier();
        totalTime /= speedBonus;
    }
    
    public override void ExecuteEffect()
    {
        // å®Œæˆé»é¤
        customer.CompleteOrder();
        
        // çµ¦äºˆç¶“é©—å€¼
        PlayerUpgradeManager.Instance.AddExperience("æœå‹™", 5);
        
        // è§¸ç™¼é»é¤å®Œæˆäº‹ä»¶
        EventSystem.Instance.TriggerEvent("OrderTaken", customer);
    }
}

// ä¸Šèœå‹•ä½œ
public class ServeFoodAction : LongAction
{
    private Table table;
    
    public ServeFoodAction(Table target) : base(LongActionType.ServeFood, 3f, target.gameObject)
    {
        table = target;
        actionName = $"ä¸Šèœåˆ° {table.tableNumber} è™Ÿæ¡Œ";
        
        // æ ¹æ“šç©å®¶å‡ç´šèª¿æ•´æ™‚é–“
        float speedBonus = PlayerUpgradeManager.Instance.GetActionSpeedMultiplier();
        totalTime /= speedBonus;
    }
    
    public override void ExecuteEffect()
    {
        // ä¸Šèœåˆ°æŒ‡å®šæ¡Œä½
        table.ServeFood();
        
        // æ›´æ–°å®¢äººç‹€æ…‹
        Customer customer = table.GetCurrentCustomer();
        if (customer != null)
        {
            customer.OnFoodServed();
        }
        
        // çµ¦äºˆç¶“é©—å€¼
        PlayerUpgradeManager.Instance.AddExperience("æœå‹™", 3);
    }
}
```

---

## ğŸ“Š è©•åˆ†ç³»çµ±æ¶æ§‹

### ğŸ† åˆ†æ•¸è¨ˆç®—ç³»çµ±

```csharp
// é¤å»³è©•åˆ†ç³»çµ±
public class RestaurantScoring : MonoBehaviour
{
    [Header("åˆ†æ•¸é…ç½®")]
    public ScoreConfig scoreConfig;               // åˆ†æ•¸é…ç½®
    
    [Header("ç•¶å‰éŠæˆ²çµ±è¨ˆ")]
    public int totalCustomersServed;              // ç¸½æœå‹™å®¢äººæ•¸
    public int customersLeft;                     // é›¢é–‹å®¢äººæ•¸
    public List<CustomerScore> customerScores;    // å®¢äººåˆ†æ•¸è¨˜éŒ„
    
    // è¨ˆç®—å®¢äººåˆ†æ•¸
    public int CalculateCustomerScore(Customer customer)
    {
        CustomerScore score = new CustomerScore(customer.customerID);
        
        // åŸºç¤æœå‹™åˆ†æ•¸
        score.baseScore = scoreConfig.baseServiceScore;
        
        // è¨ˆç®—å„é …åŠ æ¸›åˆ†
        CalculateWaitingPenalty(customer, score);
        CalculateServiceBonus(customer, score);
        CalculateTablePenalty(customer, score);
        CalculateSelfServiceScore(customer, score);
        CalculateFoodServiceScore(customer, score);
        
        // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
        int finalScore = Mathf.Max(0, score.GetTotalScore());
        
        // å®Œç¾æœå‹™çå‹µï¼šå¦‚æœå®¢äººæ²’æœ‰ä»»ä½•æ‰£åˆ†ï¼Œé¡å¤–ç²å¾—20%çå‹µ
        if (score.GetTotalPenalties() == 0 && finalScore > 0)
        {
            finalScore = Mathf.RoundToInt(finalScore * 1.2f);
            score.AddBonus(Mathf.RoundToInt(finalScore * 0.2f), "å®Œç¾æœå‹™çå‹µ");
        }
        
        score.finalScore = finalScore;
        customerScores.Add(score);
        return finalScore;
    }
    
    // è¨ˆç®—ç­‰å¾…æ‡²ç½°
    private void CalculateWaitingPenalty(Customer customer, CustomerScore score)
    {
        float queueWaitTime = customer.GetQueueWaitTime();
        
        if (queueWaitTime > scoreConfig.maxAcceptableWaitTime)
        {
            score.AddPenalty(-5, "é»é¤ç­‰å¾…æ™‚é–“éä¹…");
        }
    }
    
    // è¨ˆç®—è‡ªåŠ©æœå‹™åˆ†æ•¸
    private void CalculateSelfServiceScore(Customer customer, CustomerScore score)
    {
        SelfServiceResult result = customer.GetSelfServiceResult();
        
        int missingItems = 0;
        if (!result.hasCutlery) missingItems++;
        if (!result.hasDrink) missingItems++;
        if (!result.hasSalad) missingItems++;
        
        if (missingItems == 0)
        {
            score.AddBonus(5, "è‡ªåŠ©æœå‹™å®Œå–„");
        }
        else
        {
            score.AddPenalty(-2 * missingItems, $"è‡ªåŠ©æœå‹™ç¼ºå¤± {missingItems} é …");
        }
    }
    
    // è¨ˆç®—æœ€çµ‚ç¸½åˆ†
    public int CalculateFinalScore(List<Customer> allCustomers, float multiplier)
    {
        int totalScore = 0;
        int servedCustomers = 0;
        
        foreach (Customer customer in allCustomers)
        {
            // åªè¨ˆç®—æœªé›¢å ´çš„å®¢äºº
            if (customer.currentState == CustomerState.Checkout ||
                customer.currentState == CustomerState.Eating)
            {
                totalScore += CalculateCustomerScore(customer);
                servedCustomers++;
            }
            else if (customer.currentState == CustomerState.Leaving)
            {
                customersLeft++;
            }
        }
        
        totalCustomersServed = servedCustomers;
        
        // å¥—ç”¨å€ç‡
        int finalScore = Mathf.RoundToInt(totalScore * multiplier);
        
        // è§¸ç™¼åˆ†æ•¸è¨ˆç®—å®Œæˆäº‹ä»¶
        EventSystem.Instance.TriggerEvent("ScoreCalculated", new ScoreResult
        {
            baseScore = totalScore,
            multiplier = multiplier,
            finalScore = finalScore,
            customersServed = servedCustomers,
            customersLeft = customersLeft
        });
        
        return finalScore;
    }
    
    // ç²å–åˆ†æ•¸çµ±è¨ˆ
    public ScoreStatistics GetScoreStatistics()
    {
        return new ScoreStatistics
        {
            totalScore = customerScores.Sum(s => s.finalScore),
            averageScore = customerScores.Count > 0 ? customerScores.Average(s => s.finalScore) : 0,
            highestScore = customerScores.Count > 0 ? customerScores.Max(s => s.finalScore) : 0,
            lowestScore = customerScores.Count > 0 ? customerScores.Min(s => s.finalScore) : 0,
            customersServed = totalCustomersServed,
            customersLeft = customersLeft
        };
    }
}

// å®¢äººåˆ†æ•¸è¨˜éŒ„
[System.Serializable]
public class CustomerScore
{
    public string customerID;                     // å®¢äººID
    public int baseScore = 20;                    // åŸºç¤åˆ†æ•¸
    public List<ScoreModifier> bonuses;           // åŠ åˆ†é …ç›®
    public List<ScoreModifier> penalties;         // æ‰£åˆ†é …ç›®
    public int finalScore;                        // æœ€çµ‚åˆ†æ•¸
    
    public CustomerScore(string id)
    {
        customerID = id;
        bonuses = new List<ScoreModifier>();
        penalties = new List<ScoreModifier>();
    }
    
    public void AddBonus(int points, string reason)
    {
        bonuses.Add(new ScoreModifier(points, reason));
    }
    
    public void AddPenalty(int points, string reason)
    {
        penalties.Add(new ScoreModifier(points, reason));
    }
    
    public int GetTotalScore()
    {
        int total = baseScore;
        total += bonuses.Sum(b => b.points);
        total += penalties.Sum(p => p.points);
        return total;
    }
    
    public int GetTotalPenalties()
    {
        return Math.Abs(penalties.Sum(p => p.points));  // å›å‚³æ‰£åˆ†çš„çµ•å°å€¼
    }
}
```

---

## ğŸ”Œ ç³»çµ±æ•´åˆæ¶æ§‹

### ğŸ“¡ èˆ‡ä¸»éŠæˆ²è¯å‹•

```csharp
// é¤å»³ç³»çµ±æ•´åˆç®¡ç†å™¨
public class RestaurantIntegrationManager : MonoBehaviour
{
    [Header("ä¸»éŠæˆ²ç³»çµ±å¼•ç”¨")]
    public NurturingModeManager nurturingManager;  // é¤Šæˆæ¨¡å¼ç®¡ç†å™¨
    public EconomyManager economyManager;          // ç¶“æ¿Ÿç³»çµ±
    public PlayerProgressManager progressManager;  // ç©å®¶é€²åº¦ç®¡ç†
    
    // å¾é¤Šæˆæ¨¡å¼é€²å…¥é¤å»³
    public void EnterRestaurantFromNurturing(int availableActionPoints)
    {
        // æª¢æŸ¥è¡Œå‹•é»éœ€æ±‚
        int requiredPoints = 3;
        int gameTime = 90;
        
        if (availableActionPoints < requiredPoints)
        {
            // è¡Œå‹•é»ä¸è¶³ï¼Œè¨ˆç®—å¯ç”¨æ™‚é–“
            gameTime = availableActionPoints * 30;
            requiredPoints = availableActionPoints;
        }
        
        // æ¶ˆè€—è¡Œå‹•é»
        nurturingManager.ConsumeActionPoints(requiredPoints);
        
        // åˆå§‹åŒ–é¤å»³ç³»çµ±
        RestaurantManager.Instance.InitializeRestaurant(requiredPoints, GetStaffConfig());
        RestaurantManager.Instance.SetGameDuration(gameTime);
        
        // è¨»å†ŠçµæŸå›èª¿
        EventSystem.Instance.RegisterListener("GameEnded", OnRestaurantGameEnded);
    }
    
    // é¤å»³éŠæˆ²çµæŸå›èª¿
    private void OnRestaurantGameEnded(object scoreData)
    {
        int finalScore = (int)scoreData;
        
        // è½‰æ›åˆ†æ•¸ç‚ºé‡‘éŒ¢ (1åˆ† = 2å…ƒ)
        int moneyEarned = finalScore * 2;
        economyManager.AddMoney(moneyEarned);
        
        // è¨˜éŒ„çµ±è¨ˆ
        progressManager.RecordRestaurantGame(finalScore, moneyEarned);
        
        // è¿”å›é¤Šæˆæ¨¡å¼
        SceneManager.LoadScene("NurturingMode");
        
        // é¡¯ç¤ºçµç®—ç•«é¢
        ShowRestaurantResult(finalScore, moneyEarned);
    }
    
    // ç²å–å·¥è®€ç”Ÿé…ç½®
    private StaffConfiguration GetStaffConfig()
    {
        // å¾å­˜æª”æˆ–è¨­å®šä¸­è®€å–ç©å®¶é¸æ“‡çš„å·¥è®€ç”Ÿé…ç½®
        return new StaffConfiguration
        {
            hasCounterStaff = PlayerPrefs.GetInt("UseCounterStaff", 1) == 1,
            hasServiceStaff = PlayerPrefs.GetInt("UseServiceStaff", 1) == 1,
            hasSupplyStaff = PlayerPrefs.GetInt("UseSupplyStaff", 1) == 1
        };
    }
}

// é¤å»³æ•¸æ“šå­˜æª”ç³»çµ±
[System.Serializable]
public class RestaurantSaveData
{
    public int restaurantLevel;                   // é¤å»³ç­‰ç´š
    public int totalGamesPlayed;                  // ç¸½éŠæˆ²æ¬¡æ•¸
    public int bestScore;                         // æœ€é«˜åˆ†æ•¸
    public float averageScore;                    // å¹³å‡åˆ†æ•¸
    public int totalMoneyEarned;                  // ç¸½è³ºå–é‡‘éŒ¢
    public PlayerUpgrades upgrades;               // ç©å®¶å‡ç´š
    public List<GameRecord> gameHistory;          // éŠæˆ²æ­·å²è¨˜éŒ„
}

// é¤å»³å­˜æª”ç®¡ç†å™¨
public class RestaurantSaveManager : MonoBehaviour
{
    private const string SAVE_KEY = "RestaurantData";
    
    public void SaveRestaurantData(RestaurantSaveData data)
    {
        string jsonData = JsonUtility.ToJson(data);
        PlayerPrefs.SetString(SAVE_KEY, jsonData);
        PlayerPrefs.Save();
    }
    
    public RestaurantSaveData LoadRestaurantData()
    {
        if (PlayerPrefs.HasKey(SAVE_KEY))
        {
            string jsonData = PlayerPrefs.GetString(SAVE_KEY);
            return JsonUtility.FromJson<RestaurantSaveData>(jsonData);
        }
        
        return new RestaurantSaveData();
    }
}
```

---

## ğŸš€ ç³»çµ±åˆå§‹åŒ–æµç¨‹

### ğŸ“‹ åˆå§‹åŒ–ç®¡ç†å™¨

```csharp
// é¤å»³ç³»çµ±åˆå§‹åŒ–ç®¡ç†å™¨
public class RestaurantSystemInitializer : MonoBehaviour
{
    [Header("ç³»çµ±çµ„ä»¶")]
    public RestaurantManager restaurantManager;
    public CustomerManager customerManager;
    public StaffManager staffManager;
    public LongActionManager actionManager;
    public RestaurantScoring scoringSystem;
    
    [Header("ç’°å¢ƒçµ„ä»¶")]
    public TableManager tableManager;
    public CounterManager counterManager;
    public SelfServiceManager selfServiceManager;
    
    // ç³»çµ±åˆå§‹åŒ–é †åº
    public IEnumerator InitializeSystemAsync(StaffConfiguration config, int actionPoints)
    {
        // 1. åˆå§‹åŒ–ç’°å¢ƒç³»çµ±
        yield return StartCoroutine(InitializeEnvironment());
        
        // 2. åˆå§‹åŒ–å·¥è®€ç”Ÿç³»çµ±
        staffManager.InitializeStaff(config);
        yield return null;
        
        // 3. åˆå§‹åŒ–å®¢äººç®¡ç†ç³»çµ±
        customerManager.Initialize();
        yield return null;
        
        // 4. åˆå§‹åŒ–é•·å‹•ä½œç³»çµ±
        actionManager.Initialize();
        yield return null;
        
        // 5. åˆå§‹åŒ–è©•åˆ†ç³»çµ±
        scoringSystem.Initialize();
        yield return null;
        
        // 6. åˆå§‹åŒ–ä¸»ç®¡ç†å™¨
        restaurantManager.InitializeRestaurant(actionPoints, config);
        yield return null;
        
        // 7. å•Ÿå‹•éŠæˆ²
        restaurantManager.StartGame();
        
        Debug.Log("é¤å»³ç³»çµ±åˆå§‹åŒ–å®Œæˆ");
    }
    
    private IEnumerator InitializeEnvironment()
    {
        // åˆå§‹åŒ–é¤æ¡Œ
        tableManager.InitializeTables();
        yield return null;
        
        // åˆå§‹åŒ–æ«ƒå°
        counterManager.Initialize();
        yield return null;
        
        // åˆå§‹åŒ–è‡ªåŠ©å€
        selfServiceManager.Initialize();
        yield return null;
    }
    
    // ç³»çµ±æ¸…ç†
    public void CleanupSystem()
    {
        // åœæ­¢æ‰€æœ‰å”ç¨‹
        StopAllCoroutines();
        
        // ä¿å­˜éŠæˆ²æ•¸æ“š
        SaveGameData();
        
        // æ¸…ç†å„å€‹ç³»çµ±
        restaurantManager.Cleanup();
        customerManager.Cleanup();
        staffManager.Cleanup();
        actionManager.Cleanup();
        
        Debug.Log("é¤å»³ç³»çµ±æ¸…ç†å®Œæˆ");
    }
}
```

---

## ğŸ’¬ Claude ä½¿ç”¨æç¤º

é–‹ç™¼é¤å»³ç³»çµ±ç¨‹å¼æ¶æ§‹æ™‚è«‹æ³¨æ„ï¼š

1. **å¤šç‹€æ…‹æ©Ÿå”èª¿**: å®¢äººã€å·¥è®€ç”Ÿã€ç©å®¶å„è‡ªçš„ç‹€æ…‹æ©Ÿéœ€è¦è‰¯å¥½çš„åŒæ­¥æ©Ÿåˆ¶
2. **æ™‚é–“ç®¡ç†ç²¾ç¢ºæ€§**: 90ç§’çš„åš´æ ¼æ™‚é™è¦æ±‚ç²¾ç¢ºçš„æ™‚é–“æ§åˆ¶å’Œé¡¯ç¤º
3. **é•·å‹•ä½œç³»çµ±**: é€²åº¦ä¿å­˜å’Œæ¢å¾©æ©Ÿåˆ¶æ˜¯æ ¸å¿ƒï¼Œéœ€è¦å®Œå–„çš„ä¸­æ–·è™•ç†
4. **AIè¡Œç‚ºé‚è¼¯**: å·¥è®€ç”Ÿçš„è‡ªå‹•åŒ–è¡Œç‚ºéœ€è¦åˆç†çš„å„ªå…ˆç´šå’Œæ±ºç­–é‚è¼¯
5. **æ€§èƒ½è€ƒæ…®**: å¤šå€‹å®¢äººåŒæ™‚é‹è¡Œç‹€æ…‹æ©Ÿï¼Œéœ€è¦è€ƒæ…®æ€§èƒ½å„ªåŒ–
6. **äº‹ä»¶ç³»çµ±**: å¤§é‡çš„äº’å‹•äº‹ä»¶éœ€è¦æ¸…æ™°çš„äº‹ä»¶ç®¡ç†æ¶æ§‹
7. **UIéŸ¿æ‡‰æ€§**: å³æ™‚çš„é€²åº¦æ¢ã€åˆ†æ•¸é¡¯ç¤ºéœ€è¦æµæš¢çš„æ›´æ–°æ©Ÿåˆ¶
8. **å¹³è¡¡æ€§èª¿æ ¡**: åˆ†æ•¸è¨ˆç®—å’Œå‡ç´šæ•ˆæœéœ€è¦å¤§é‡æ¸¬è©¦ä¾†ç¢ºä¿å¹³è¡¡æ€§