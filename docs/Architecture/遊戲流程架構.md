# 🎮 遊戲流程架構

> LoveTide 遊戲的整體流程控制與場景管理架構

---

## 🎯 概述

遊戲流程架構負責管理從啟動到結束的完整遊戲體驗，包括場景切換、狀態管理、進度保存等核心功能。

---

## 🧱 流程模組結構

### 📊 主要流程管理器
- **GameManagerTest.cs**: 主遊戲邏輯控制器
  - 場景狀態管理
  - 遊戲進度控制
  - 系統初始化
  - 存檔/載入協調

### 🎭 場景控制器
- **BackgroundCtrl.cs**: 背景場景控制
  - 靜態背景切換
  - Spine 動畫背景
  - 場景過渡效果
  - 環境氛圍控制

---

## 🔄 遊戲狀態機

### 📋 主要遊戲狀態
```csharp
public enum GameState
{
    Initialize,    // 初始化
    MainMenu,      // 主選單
    Loading,       // 載入中
    Playing,       // 遊戲中
    Dialog,        // 對話中
    MiniGame,      // 小遊戲
    Paused,        // 暫停
    Settings,      // 設定
    Saving         // 存檔中
}
```

### 🎯 狀態轉換邏輯
```
Initialize → MainMenu → Loading → Playing
    ↓           ↓         ↓        ↓
Settings ←─── Settings ←─ Settings ←─ Dialog
    ↓           ↓         ↓        ↓
MainMenu ←─── Loading ←─ Paused ←─ MiniGame
```

---

## 🎬 遊戲啟動流程

### 📱 啟動序列
1. **系統初始化**
   - Unity 引擎初始化
   - 資源系統載入
   - 音效系統啟動
   - UI 系統初始化

2. **遊戲數據載入**
   - 讀取遊戲設定
   - 載入玩家存檔
   - 初始化遊戲數據
   - 檢查版本兼容性

3. **主選單顯示**
   - 顯示主選單介面
   - 播放背景音樂
   - 載入主選單背景
   - 等待玩家操作

### 🎮 主選單功能
```csharp
public class MainMenuController : MonoBehaviour
{
    public void StartNewGame();     // 開始新遊戲
    public void LoadGame();         // 載入遊戲
    public void OpenSettings();     // 打開設定
    public void QuitGame();         // 退出遊戲
}
```

---

## 🏠 主遊戲流程

### 🎯 遊戲循環
```
場景載入 → 角色初始化 → 等待玩家操作 → 處理選擇 → 更新遊戲狀態 → 儲存進度
    ↑                                                                    ↓
場景切換 ←─── 觸發條件檢查 ←─── UI更新 ←─── 動畫播放 ←─── 邏輯處理 ←─────────┘
```

### 📅 日常互動流程
1. **時間段選擇**
   - 顯示當前時間
   - 列出可用活動
   - 玩家選擇活動
   - 檢查活動條件

2. **活動執行**
   - 載入活動場景
   - 播放開場動畫
   - 進入活動邏輯
   - 計算活動結果

3. **結果處理**
   - 更新遊戲數據
   - 顯示結果反饋
   - 檢查解鎖條件
   - 自動存檔

---

## 🎭 劇情流程架構

### 📝 劇情觸發機制
```csharp
public class StoryTrigger
{
    public int storyId;                    // 劇情ID
    public List<Condition> conditions;     // 觸發條件
    public StoryType storyType;           // 劇情類型
    public bool isRepeatable;             // 是否可重複
}
```

### 🎪 劇情播放流程
1. **觸發檢查**
   - 檢查觸發條件
   - 驗證前置劇情
   - 確認角色狀態
   - 檢查時間限制

2. **劇情執行**
   - 載入劇情數據
   - 切換場景背景
   - 播放角色動畫
   - 顯示對話內容

3. **選擇分支**
   - 顯示選項列表
   - 等待玩家選擇
   - 記錄選擇結果
   - 影響後續劇情

---

## 🎮 小遊戲整合流程

### 🎯 小遊戲啟動
```csharp
public class MiniGameManager : MonoBehaviour
{
    public void StartMiniGame(MiniGameType gameType)
    {
        // 1. 保存當前遊戲狀態
        // 2. 切換到小遊戲場景
        // 3. 初始化小遊戲數據
        // 4. 開始小遊戲循環
    }
}
```

### 🏆 小遊戲結束流程
1. **結果計算**
   - 計算遊戲分數
   - 判定成功失敗
   - 計算獎勵內容
   - 更新統計數據

2. **獎勵發放**
   - 增加金錢收入
   - 提升技能經驗
   - 解鎖新內容
   - 記錄成就進度

3. **返回主遊戲**
   - 恢復遊戲狀態
   - 切換回主場景
   - 顯示結果摘要
   - 繼續遊戲流程

---

## 💾 存檔系統整合

### 📋 自動存檔時機
- **劇情節點**: 重要劇情完成後
- **日期變化**: 每日結束時
- **選擇完成**: 重要選擇後
- **小遊戲結束**: 小遊戲完成後
- **設定變更**: 遊戲設定修改後

### 🔄 存檔數據結構
```csharp
public class GameSaveData
{
    // 遊戲進度
    public int currentDay;
    public string currentScene;
    public int storyProgress;
    
    // 角色數據
    public Dictionary<string, int> characterAffection;
    public Dictionary<string, bool> unlockedContent;
    
    // 遊戲數據
    public int playerMoney;
    public Dictionary<string, int> playerStats;
    public List<string> completedStories;
}
```

---

## 🎵 音效系統整合

### 🔊 音效觸發時機
- **場景切換**: 自動播放對應BGM
- **劇情播放**: 根據劇情內容播放音效
- **UI操作**: 按鈕點擊等操作音效
- **小遊戲**: 遊戲專用音效和音樂

### 🎶 音效管理策略
```csharp
public class AudioIntegration
{
    public void OnSceneChanged(string sceneName)
    {
        // 根據場景切換BGM
        audioManager.PlayBGM(GetSceneBGM(sceneName));
    }
    
    public void OnStoryEvent(string eventType)
    {
        // 根據劇情事件播放音效
        audioManager.PlaySFX(GetStorySound(eventType));
    }
}
```

---

## 🔧 系統監控與除錯

### 📊 性能監控
- **FPS監控**: 實時顯示遊戲幀率
- **記憶體使用**: 監控記憶體消耗
- **載入時間**: 記錄場景載入時間
- **用戶行為**: 追蹤玩家操作模式

### 🛠 除錯工具
```csharp
public class DebugManager : MonoBehaviour
{
    [Header("Debug Options")]
    public bool showFPS;
    public bool showMemoryUsage;
    public bool enableCheatMode;
    
    public void SkipToStory(int storyId);
    public void AddMoney(int amount);
    public void SetAffection(string character, int value);
}
```

---

## 🔌 擴展性考量

### 🧩 模組化設計
- **場景模組**: 獨立的場景管理
- **劇情模組**: 可插拔的劇情系統
- **小遊戲模組**: 標準化的小遊戲介面
- **存檔模組**: 統一的數據持久化

### 🎯 未來擴展
- **多語言支援**: 本地化流程整合
- **雲端存檔**: 雲端同步功能
- **更新系統**: 內容更新機制
- **分析系統**: 用戶行為分析

---

## 💬 Claude 使用提示

了解遊戲流程架構時請：
1. 先理解整體狀態機設計
2. 關注各系統間的協作方式
3. 注意存檔和載入的時機
4. 理解場景切換的邏輯
5. 搭配閱讀 `CodeModules/GameManagerTest.md` 了解實作細節

修改流程架構時需要：
- 確保狀態轉換的正確性
- 考慮向後兼容性
- 測試各種邊界情況
- 更新相關的系統文件